{% extends 'home.html' %}
<title>{% block title %}{{title}}{% endblock %}</title>
{% load static %}
{% block css %}
    <script src="https://cdn.tailwindcss.com"></script>
{%  endblock css %}

{% block scripts %}
    {% if modo_edicion and pago and PAYPAL_CLIENT_ID %}
    <script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD"></script>
    {% endif %}
{% endblock scripts %}
{% block content %}
<section class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 dark:from-gray-900 dark:to-blue-900 relative">
   <!-- Medical pattern background que cubre toda la pantalla -->
   <div class="fixed inset-0 opacity-5 dark:opacity-10 pointer-events-none z-0">
      <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
         <defs>
            <pattern id="medical-cross-main" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
               <path d="M15 10h10v5h5v10h-5v5h-10v-5h-5v-10h5z" fill="currentColor" opacity="0.1"/>
            </pattern>
         </defs>
         <rect width="100%" height="100%" fill="url(#medical-cross-main)" class="text-blue-500 dark:text-blue-400"/>
      </svg>
   </div>

   <!-- Navigation -->
   <nav class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg shadow-xl sticky top-0 z-10 border-b border-gray-200/50 dark:border-gray-700/50">
      <div class="container mx-auto px-6">
         <div class="flex space-x-0">
            <button onclick="showTab('paciente')" id="tab-paciente" class="tab-button flex-1 py-4 px-6 text-center border-b-4 border-blue-500 text-blue-600 dark:text-blue-400 font-semibold transition-all duration-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 bg-blue-50/50 dark:bg-blue-900/20">
               <div class="flex items-center justify-center space-x-2">
                  <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg transform scale-110">
                     <i class="fas fa-user-injured text-white text-sm"></i>
                  </div>
                  <span>Datos del Paciente</span>
                  <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
               </div>
            </button>
            <button onclick="showTab('consultas')" id="tab-consultas" class="tab-button flex-1 py-4 px-6 text-center border-b-4 border-transparent text-gray-500 dark:text-gray-400 font-semibold transition-all duration-300 hover:bg-gray-50 dark:hover:bg-gray-700/30 hover:text-gray-700 dark:hover:text-gray-300">
               <div class="flex items-center justify-center space-x-2">
                  <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center shadow-lg">
                     <i class="fas fa-file-medical-alt text-white text-sm"></i>
                  </div>
                  <span>Consultas Anteriores</span>
               </div>
            </button>
            <button onclick="showTab('atencion')" id="tab-atencion" class="tab-button flex-1 py-4 px-6 text-center border-b-4 border-transparent text-gray-500 dark:text-gray-400 font-semibold transition-all duration-300 hover:bg-gray-50 dark:hover:bg-gray-700/30 hover:text-gray-700 dark:hover:text-gray-300">
               <div class="flex items-center justify-center space-x-2">
                  <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg">
                     <i class="fas fa-clipboard-check text-white text-sm"></i>
                  </div>
                  <span>Atención Actual</span>
               </div>
            </button>
         </div>
      </div>
   </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
     <!-- Datos del Paciente -->
        <div id="content-paciente" class="tab-content active">
            <!-- Selector de Paciente -->
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 card-hover transition-all duration-300 border border-gray-200/50 dark:border-gray-700/50 relative z-10">
                <div class="relative">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fas fa-search text-white text-lg"></i>
                        </div>
                        Selección de Paciente
                    </h2>

                    <div class="flex flex-col md:flex-row gap-4 items-end">
                        <div class="flex-1 relative">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Buscar y Seleccionar Paciente</label>
                            <div class="relative">
                                <input
                                    type="text"
                                    id="paciente-search-input"
                                    placeholder="Escriba el nombre, apellido o cédula del paciente..."
                                    class="w-full p-4 pr-12 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700"
                                    autocomplete="off"
                                >
                                <div id="loading-indicator" class="absolute right-4 top-1/2 transform -translate-y-1/2 hidden">
                                    <svg class="w-5 h-5 text-blue-500 loading-spinner" fill="none" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle>
                                        <path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path>
                                    </svg>
                                </div>
                                <div id="search-icon" class="absolute right-4 top-1/2 transform -translate-y-1/2">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <button id="clear-button" class="absolute right-4 top-1/2 transform -translate-y-1/2 hidden hover:bg-gray-100 dark:hover:bg-gray-600 rounded-full p-1" onclick="limpiarSeleccion()">
                                    <i class="fas fa-times text-gray-500 dark:text-gray-400"></i>
                                </button>
                            </div>
                            <div id="pacientes-dropdown" class="absolute z-50 w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl shadow-lg mt-1 max-h-60 overflow-y-auto dropdown-closed transition-all duration-200">
                                <div id="pacientes-list" class="py-2"></div>
                                <div id="no-results" class="p-4 text-center text-gray-500 dark:text-gray-400 hidden">
                                    <i class="fas fa-user-slash text-3xl text-gray-300 dark:text-gray-500 mb-2"></i><br>
                                    No se encontraron pacientes
                                </div>
                                <div id="min-chars-message" class="p-4 text-center text-gray-500 dark:text-gray-400 hidden">
                                    <i class="fas fa-keyboard text-3xl text-gray-300 dark:text-gray-500 mb-2"></i><br>
                                    Escriba al menos 3 caracteres para buscar
                                </div>
                            </div>
                        </div>
                        <button onclick="mostrarFormularioNuevoPaciente()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-xl transition-colors duration-200 flex items-center space-x-2 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <i class="fas fa-user-plus"></i>
                            <span>Agregar Paciente</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Datos del Paciente Seleccionado -->
            <div id="datos-paciente-container" class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 hidden border border-gray-200/50 dark:border-gray-700/50 relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fas fa-user-check text-white text-lg"></i>
                        </div>
                        Datos del Paciente
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 p-4 rounded-xl border border-blue-200/50 dark:border-blue-700/50 col-span-1 md:col-span-2 lg:col-span-3">
                            <div class="flex items-center space-x-4">
                                <div id="paciente-avatar" class="w-14 h-14 rounded-full overflow-hidden border-2 border-white shadow-lg bg-gradient-to-r from-blue-500 to-indigo-500 flex items-center justify-center">
                                    <img id="paciente-foto" src="{% static 'img/usuario_anonimo.png' %}" alt="Foto del paciente" class="w-full h-full object-cover rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <i class="fas fa-user text-white text-xl hidden"></i>
                                </div>
                                <div>
                                    <div id="paciente-nombre" class="font-semibold text-gray-800 dark:text-white text-lg">Nombre del Paciente</div>
                                    <div id="paciente-cedula" class="text-sm text-blue-600 dark:text-blue-400 font-medium">CI: 0000000000</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/30 dark:to-pink-900/30 p-4 rounded-xl border border-purple-200/50 dark:border-purple-700/50">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg flex items-center justify-center shadow-md"><i class="fas fa-phone text-white text-sm"></i></div>
                                <div>
                                    <div class="text-sm text-purple-600 dark:text-purple-400 font-medium">Teléfono</div>
                                    <div id="paciente-telefono" class="font-semibold text-gray-800 dark:text-white">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-teal-50 to-cyan-50 dark:from-teal-900/30 dark:to-cyan-900/30 p-4 rounded-xl border border-teal-200/50 dark:border-teal-700/50">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-teal-500 to-cyan-500 rounded-lg flex items-center justify-center shadow-md"><i class="fas fa-envelope text-white text-sm"></i></div>
                                <div>
                                    <div class="text-sm text-teal-600 dark:text-teal-400 font-medium">Email</div>
                                    <div id="paciente-email" class="font-semibold text-gray-800 dark:text-white">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/30 dark:to-red-900/30 p-4 rounded-xl border border-orange-200/50 dark:border-orange-700/50">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-red-500 rounded-lg flex items-center justify-center shadow-md"><i class="fas fa-birthday-cake text-white text-sm"></i></div>
                                <div>
                                    <div class="text-sm text-orange-600 dark:text-orange-400 font-medium">Edad</div>
                                    <div id="paciente-edad" class="font-semibold text-gray-800 dark:text-white">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 bg-gradient-to-r from-gray-50 to-blue-50 dark:from-gray-800/50 dark:to-blue-900/30 p-4 rounded-xl border border-gray-200/50 dark:border-gray-700/50">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-gray-500 to-blue-500 rounded-lg flex items-center justify-center shadow-md"><i class="fas fa-map-marker-alt text-white text-sm"></i></div>
                                <div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 font-medium">Dirección</div>
                                    <div id="paciente-direccion" class="font-semibold text-gray-800 dark:text-white">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Historia Clínica -->
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 p-6 rounded-xl border border-indigo-200/50 dark:border-indigo-700/50">
                         <h4 class="text-lg font-bold text-indigo-800 dark:text-indigo-300 mb-4 flex items-center">
                            <div class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center mr-3 shadow-md"><i class="fas fa-file-medical text-white text-sm"></i></div>
                            Historia Clínica
                        </h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-lg border border-gray-200/50 dark:border-gray-700/50">
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-user-md text-blue-500 mr-2"></i>Antecedentes Personales</label>
                                <textarea id="antecedentes-personales" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" readonly></textarea>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-lg border border-gray-200/50 dark:border-gray-700/50">
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-cut text-red-500 mr-2"></i>Antecedentes Quirúrgicos</label>
                                <textarea id="antecedentes-quirurgicos" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" readonly></textarea>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-lg border border-gray-200/50 dark:border-gray-700/50">
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-users text-green-500 mr-2"></i>Antecedentes Familiares</label>
                                <textarea id="antecedentes-familiares" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" readonly></textarea>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-lg border border-gray-200/50 dark:border-gray-700/50">
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>Alergias</label>
                                <textarea id="alergias" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" readonly></textarea>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-lg border border-gray-200/50 dark:border-gray-700/50">
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-pills text-purple-500 mr-2"></i>Medicamentos Actuales</label>
                                <textarea id="medicamentos-actuales" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" readonly></textarea>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-lg border border-gray-200/50 dark:border-gray-700/50">
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-smoking text-orange-500 mr-2"></i>Hábitos Tóxicos</label>
                                <textarea id="habitos-toxicos" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" readonly></textarea>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-lg border border-gray-200/50 dark:border-gray-700/50">
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-syringe text-teal-500 mr-2"></i>Vacunas</label>
                                <textarea id="vacunas" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" readonly></textarea>
                            </div>
                            <div class="bg-white/70 dark:bg-gray-800/70 p-4 rounded-lg border border-gray-200/50 dark:border-gray-700/50">
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center"><i class="fas fa-venus text-pink-500 mr-2"></i>Antecedentes Gineco-obstétricos</label>
                                <textarea id="antecedentes-gineco" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" readonly></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mensaje cuando no hay paciente seleccionado -->
            <div id="no-paciente-mensaje" class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 text-center border border-gray-200/50 dark:border-gray-700/50 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="w-20 h-20 bg-gradient-to-r from-gray-100 to-blue-100 dark:from-gray-700 dark:to-blue-800 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-user-plus text-2xl text-gray-400 dark:text-gray-500"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Seleccione un paciente</h3>
                    <p class="text-gray-500 dark:text-gray-400">Para continuar, busque y seleccione un paciente de la lista o agregue uno nuevo.</p>
                </div>
            </div>
            <!-- Modal Agregar Paciente si no existe -->
            {% include "components/modal_paciente.html"  %}
        </div>

        <!-- Consultas Anteriores -->
        <div id="content-consultas" class="tab-content hidden">
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 border border-gray-200/50 dark:border-gray-700/50 relative overflow-hidden">
                <div class="relative z-10">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2 flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fas fa-file-medical-alt text-white text-lg"></i>
                        </div>
                        Historial de Consultas
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400">Registro completo de atenciones médicas anteriores</p>
                </div>
            </div>
            <div id="consultas-container" class="space-y-6"></div>
            <div id="no-consultas-mensaje" class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-12 text-center border border-gray-200/50 dark:border-gray-700/50 relative overflow-hidden hidden">
                <div class="relative z-10">
                    <div class="w-20 h-20 bg-gradient-to-r from-gray-100 to-indigo-100 dark:from-gray-700 dark:to-indigo-800 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class="fas fa-file-medical text-2xl text-gray-400 dark:text-gray-500"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Sin consultas registradas</h3>
                    <p class="text-gray-500 dark:text-gray-400">Este paciente no tiene atenciones médicas registradas en el sistema.</p>
                </div>
            </div>
        </div>

        <!-- Atención Actual -->
         <div id="content-atencion" class="tab-content hidden">
            <div class="space-y-8">
              <form id="atencion-form" onsubmit="event.preventDefault(); grabarAtencion();">
                    {% csrf_token %}
                    <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 border border-gray-200/50 dark:border-gray-700/50">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-clipboard-list text-white text-lg"></i>
                            </div>
                            Identificación de la Atención
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl border-l-4 border-blue-400 md:col-span-2">
                                <h3 class="font-semibold text-blue-800 dark:text-blue-300 mb-2">Paciente</h3>
                                <p id="paciente-nombre2" class="text-blue-700 dark:text-blue-200 text-lg">Seleccione un paciente</p>
                                <input type="hidden" id="id_paciente">
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl border-l-4 border-green-400 text-center flex flex-col items-center justify-center">
                                 <div id="paciente-avatar2" class="w-24 h-24 rounded-full overflow-hidden mx-auto border-2 border-white shadow-lg bg-gradient-to-r from-green-500 to-emerald-500 flex items-center justify-center">
                                    <img id="paciente-foto2" src="{% static 'img/usuario_anonimo.png' %}" alt="Foto del paciente" class="w-full h-full object-cover rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <i class="fas fa-user text-white text-2xl hidden"></i>
                                </div>
                                 <span id="paciente-edad2" class="text-blue-800 dark:text-blue-300 text-xl font-bold mt-2">Edad</span>
                                <input type="hidden" id="id_doctor" value="1">
                            </div>

                        </div>
                    </div>

                    <!-- Signos Vitales -->
                    <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 border border-gray-200/50 dark:border-gray-700/50">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-red-500 to-orange-500 rounded-xl flex items-center justify-center mr-3 shadow-lg">
                                <i class="fas fa-heartbeat text-white"></i>
                            </div>
                            Signos Vitales y Mediciones
                        </h3>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-xl text-center">
                                <h4 class="font-semibold text-red-800 dark:text-red-300 text-sm">Presión Arterial</h4>
                                <input type="text" id="id_presion_arterial" value="{{ atencion.presion_arterial|default:'' }}" class="w-full mt-2 p-2 border border-red-200 dark:border-red-700 rounded-lg text-center font-bold text-red-700 dark:text-red-200 bg-white dark:bg-red-900/50" placeholder="120/80">
                            </div>
                            <div class="bg-pink-50 dark:bg-pink-900/30 p-4 rounded-xl text-center">
                                <h4 class="font-semibold text-pink-800 dark:text-pink-300 text-sm">Pulso (ppm)</h4>
                                <input type="number" id="id_pulso" value="{{ atencion.pulso|default:'' }}" class="w-full mt-2 p-2 border border-pink-200 dark:border-pink-700 rounded-lg text-center font-bold text-pink-700 dark:text-pink-200 bg-white dark:bg-pink-900/50" placeholder="72">
                            </div>
                            <div class="bg-orange-50 dark:bg-orange-900/30 p-4 rounded-xl text-center">
                                <h4 class="font-semibold text-orange-800 dark:text-orange-300 text-sm">Temperatura (°C)</h4>
                                <input type="number" step="0.1" id="id_temperatura" value="{{ atencion.temperatura|stringformat:'g'|default:'' }}" class="w-full mt-2 p-2 border border-orange-200 dark:border-orange-700 rounded-lg text-center font-bold text-orange-700 dark:text-orange-200 bg-white dark:bg-orange-900/50" placeholder="36.5">
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl text-center">
                                <h4 class="font-semibold text-blue-800 dark:text-blue-300 text-sm">Freq. Respiratoria</h4>
                                <input type="number" id="id_frecuencia_respiratoria" value="{{ atencion.frecuencia_respiratoria|stringformat:'g'|default:'' }}" class="w-full mt-2 p-2 border border-blue-200 dark:border-blue-700 rounded-lg text-center font-bold text-blue-700 dark:text-blue-200 bg-white dark:bg-blue-900/50" placeholder="16">
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-xl text-center">
                                <h4 class="font-semibold text-green-800 dark:text-green-300 text-sm">Saturación O2 (%)</h4>
                                <input type="number" id="id_saturacion_oxigeno" value="{{ atencion.saturacion_oxigeno|stringformat:'g'|default:'' }}" class="w-full mt-2 p-2 border border-green-200 dark:border-green-700 rounded-lg text-center font-bold text-green-700 dark:text-green-200 bg-white dark:bg-green-900/50" placeholder="98">
                            </div>
                            <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-xl text-center">
                                <h4 class="font-semibold text-purple-800 dark:text-purple-300 text-sm">Peso (kg)</h4>
                                <input type="number" step="0.1" id="id_peso" value="{{ atencion.peso|stringformat:'g'|default:'' }}" class="w-full mt-2 p-2 border border-purple-200 dark:border-purple-700 rounded-lg text-center font-bold text-purple-700 dark:text-purple-200 bg-white dark:bg-purple-900/50" placeholder="70.5">
                            </div>
                            <div class="bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-xl text-center">
                                <h4 class="font-semibold text-indigo-800 dark:text-indigo-300 text-sm">Altura (m)</h4>
                                <input type="number" step="0.01" id="id_altura" value="{{ atencion.altura|stringformat:'g' }}" class="w-full mt-2 p-2 border border-indigo-200 dark:border-indigo-700 rounded-lg text-center font-bold text-indigo-700 dark:text-indigo-200 bg-white dark:bg-indigo-900/50" placeholder="1.75">
                            </div>
                            <div class="bg-teal-50 dark:bg-teal-900/30 p-4 rounded-xl text-center">
                                <h4 class="font-semibold text-teal-800 dark:text-teal-300 text-sm mb-3">Consulta Control</h4>
                                <div class="flex items-center justify-center">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="id_consulta_control" {% if atencion.es_control %}checked{% endif %} class="sr-only peer">
                                        <div class="relative w-11 h-6 bg-gray-200 dark:bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-teal-300 dark:peer-focus:ring-teal-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-teal-600"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Evaluación Clínica -->
                    <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 border border-gray-200/50 dark:border-gray-700/50">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-emerald-500 to-green-500 rounded-xl flex items-center justify-center mr-3 shadow-lg">
                                <i class="fas fa-stethoscope text-white"></i>
                            </div>
                            Evaluación Clínica
                        </h3>
                        
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">Motivo de Consulta *</label>
                                        <button type="button" onclick="iniciarDictado(event, 'id_motivo_consulta')" class="flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 transition-colors">
                                            <i class="fas fa-microphone mr-1"></i><span>Dictar</span>
                                        </button>
                                    </div>
                                    <textarea id="id_motivo_consulta" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" rows="3" placeholder="Ingrese el motivo de la consulta...">{{ atencion.motivo_consulta|default:'' }}</textarea>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">Síntomas *</label>
                                        <button type="button" onclick="iniciarDictado(event, 'id_sintomas')" class="flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 transition-colors">
                                            <i class="fas fa-microphone mr-1"></i><span>Dictar</span>
                                        </button>
                                    </div>
                                    <textarea id="id_sintomas" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" rows="3" placeholder="Describa los síntomas presentados...">{{ atencion.sintomas|default:'' }}</textarea>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">Examen Físico</label>
                                    <button type="button" onclick="iniciarDictado(event, 'id_examen_fisico')" class="flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 transition-colors">
                                        <i class="fas fa-microphone mr-1"></i><span>Dictar</span>
                                    </button>
                                </div>
                                <textarea id="id_examen_fisico" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" rows="4" placeholder="Hallazgos del examen físico...">{{ atencion.examen_fisico|default:'' }}</textarea>
                            </div>
                           
                           <div class="bg-pink-50 dark:bg-pink-900/30 border border-pink-200 dark:border-pink-700 rounded-lg p-4">
                             <label class="block text-sm font-semibold text-pink-800 dark:text-pink-300 mb-2">Diagnóstico(s) *</label>
                              <div class="bg-white dark:bg-gray-800/50 p-4 rounded-xl">
                                <div class="flex items-center space-x-3 mb-3">
                                    <select id="id_diagnostico" multiple class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg h-32 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" size="5">
                                        {% for diagnostico in diagnosticos %}
                                            <option value="{{ diagnostico.id }}" {% if atencion and diagnostico in atencion.diagnostico.all %}selected{% endif %} title="{{ diagnostico.datos_adicionales|default:'' }}">
                                                 {{ diagnostico.codigo }} - {{ diagnostico.descripcion }}
                                            </option>
                                        {% empty %}
                                            <option value="" disabled>No hay diagnósticos disponibles</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div id="diagnosticos-lista" class="text-sm text-gray-600 dark:text-gray-400"></div>
                            </div>
                            </div>
                     </div>
                    </div>

                    <!-- Plan Terapéutico -->
                    <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 border border-gray-200/50 dark:border-gray-700/50">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-xl flex items-center justify-center mr-3 shadow-lg">
                                <i class="fas fa-notes-medical text-white"></i>
                            </div>
                            Plan Terapéutico
                        </h3>

                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Plan de Tratamiento *</label>
                                <textarea id="id_tratamiento" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" rows="4" placeholder="Detalle el plan de tratamiento...">{{ atencion.tratamiento|default:'' }}</textarea>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">Exámenes Enviados</label>
                                    <button type="button" onclick="iniciarDictado(event, 'id_examenes_enviados')" class="flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 transition-colors">
                                        <i class="fas fa-microphone mr-1"></i><span>Dictar</span>
                                    </button>
                                </div>
                                <textarea id="id_examenes_enviados" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" rows="4" placeholder="Exámenes de laboratorio, imágenes, etc.">{{ atencion.examenes_enviados|default:'' }}</textarea>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">Comentario Adicional</label>
                                    <button type="button" onclick="iniciarDictado(event, 'id_comentario_adicional')" class="flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 transition-colors">
                                        <i class="fas fa-microphone mr-1"></i><span>Dictar</span>
                                    </button>
                                </div>
                                <textarea id="id_comentario_adicional" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" rows="3" placeholder="Comentarios adicionales...">{{ atencion.comentario_adicional|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Prescripción de Medicamentos -->
                    <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 border border-gray-200/50 dark:border-gray-700/50">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-rose-500 to-red-500 rounded-xl flex items-center justify-center mr-3 shadow-lg">
                                <i class="fas fa-pills text-white"></i>
                            </div>
                            Prescripción de Medicamentos
                        </h3>

                        <div class="bg-gray-50 dark:bg-gray-800/50 p-6 rounded-xl mb-6 border border-gray-200 dark:border-gray-700">
                            <h4 class="font-semibold text-gray-800 dark:text-white mb-4">Agregar Medicamento</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                               <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Medicamento *</label>
                                    <select id="medicamento-select" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-rose-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" name="medicamento_id" required>
                                        <option value="">Seleccione medicamento...</option>
                                        {% for medicamento in medicamentos %}
                                            <option value="{{ medicamento.id }}" title="{{ medicamento.nombre }} {{ medicamento.concentracion }} - {{ medicamento.tipo.nombre }} ({{ medicamento.marca_medicamento.nombre }}) - ${{ medicamento.precio }} - Stock: {{ medicamento.cantidad }}">
                                                {{ medicamento.nombre }}
                                            </option>
                                        {% empty %}
                                            <option value="" disabled>No hay medicamentos disponibles</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cantidad *</label>
                                    <input type="number" id="cantidad-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-rose-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" placeholder="30">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Prescripción *</label>
                                    <input type="text" id="prescripcion-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-rose-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" placeholder="1 cada 8 horas">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duración (días) *</label>
                                    <input type="number" id="duracion-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-rose-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" placeholder="7">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Frecuencia diaria *</label>
                                    <input type="number" id="frecuencia-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-rose-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" placeholder="3">
                                </div>
                            </div>
                            <div class="mt-4 flex space-x-3">
                                <button type="button" onclick="agregarMedicamento()" class="bg-rose-600 hover:bg-rose-700 text-white px-6 py-3 rounded-lg transition-all duration-200 flex items-center space-x-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                    <i class="fas fa-plus-circle"></i>
                                    <span>Add Prescripción</span>
                                </button>
                                <button type="button" onclick="verDatos()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg transition-colors duration-200">
                                    Crear Medicamentos
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b-2 border-gray-200 dark:border-gray-700">
                                        <th class="text-left py-4 px-4 font-semibold text-gray-700 dark:text-gray-300">Medicamento</th>
                                        <th class="text-left py-4 px-4 font-semibold text-gray-700 dark:text-gray-300">Cantidad</th>
                                        <th class="text-left py-4 px-4 font-semibold text-gray-700 dark:text-gray-300">Prescripción</th>
                                        <th class="text-left py-4 px-4 font-semibold text-gray-700 dark:text-gray-300">Duración (días)</th>
                                        <th class="text-left py-4 px-4 font-semibold text-gray-700 dark:text-gray-300">Frecuencia</th>
                                        <th class="text-left py-4 px-4 font-semibold text-gray-700 dark:text-gray-300">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="medicamentos-table" class="divide-y divide-gray-200 dark:divide-gray-700">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Servicios Adicionales -->
                    <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mb-8 border border-gray-200/50 dark:border-gray-700/50">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-3 shadow-lg">
                                <i class="fas fa-hand-holding-medical text-white"></i>
                            </div>
                            Servicios Adicionales
                        </h3>

                        <div id="formset-servicios-container">
                            {{ formset_servicios.management_form }}
                            {% for form in formset_servicios %}
                                <div class="formset-row-servicio bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl mb-4 border border-gray-200 dark:border-gray-700">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Servicio *</label>
                                            {{ form.servicio }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cantidad *</label>
                                            {{ form.cantidad }}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Observaciones</label>
                                            {{ form.observaciones }}
                                        </div>
                                    </div>
                                    {% if form.instance.pk %}
                                        <button type="button" class="delete-row-button mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors duration-200" data-form-id="{{ form.prefix }}">Eliminar</button>
                                    {% else %}
                                        <button type="button" class="delete-row-button mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors duration-200">Eliminar</button>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <button type="button" id="add-servicio-button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-all duration-200 flex items-center space-x-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 mt-4">
                            <i class="fas fa-plus-circle"></i>
                            <span>Añadir Servicio</span>
                        </button>
                    </div>

                    <!-- Botón de Guardar -->
                    <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mt-8 border border-gray-200/50 dark:border-gray-700/50">
                        <div class="flex justify-center space-x-4">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-lg text-lg font-semibold transition-all duration-200 flex items-center space-x-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                                <i class="fas fa-save"></i>
                                <span>Guardar Atención Médica</span>
                            </button>
                            <button type="button" onclick="window.history.back()" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-4 rounded-lg text-lg font-semibold transition-colors duration-200">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Sección de Pago (Solo en modo edición) -->
                {% if modo_edicion and pago %}
                <div id="payment-section" class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg rounded-2xl shadow-xl p-8 mt-8 border border-gray-200/50 dark:border-gray-700/50">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
                        <div class="w-12 h-12 bg-gradient-to-r from-teal-500 to-cyan-500 rounded-xl flex items-center justify-center mr-4 shadow-lg">
                            <i class="fas fa-credit-card text-white text-lg"></i>
                        </div>
                        Gestión de Pago
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                        <!-- Detalles del Pago -->
                        <div class="bg-gray-50 dark:bg-gray-700/50 p-6 rounded-xl border border-gray-200 dark:border-gray-600">
                            <h3 class="font-semibold text-lg text-gray-800 dark:text-white mb-4">Resumen de la Deuda</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Monto Total:</span>
                                    <span id="monto-total" class="font-bold text-2xl text-teal-600 dark:text-teal-400">{{ pago.monto_total|default:"0.00" }} USD</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-600 dark:text-gray-400">Estado del Pago:</span>
                                    <span id="pago-estado" class="px-3 py-1 rounded-full text-sm font-semibold 
                                        {% if pago.estado == 'pagado' %} bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300 
                                        {% elif pago.estado == 'pendiente' %} bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300
                                        {% else %} bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300 {% endif %}">
                                        {{ pago.get_estado_display }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Botón de PayPal y Mensajes -->
                        <div id="paypal-container" class="text-center">
                            {% if pago.estado == 'pendiente' %}
                                <p class="text-gray-600 dark:text-gray-400 mb-4">Seleccione el método de pago para continuar.</p>
                                <div id="paypal-button-container"></div>
                                <div id="paypal-messages" class="mt-4 text-sm"></div>
                            {% else %}
                                <div class="text-center text-green-600 dark:text-green-400">
                                    <i class="fas fa-check-circle fa-3x"></i>
                                    <p class="mt-2 font-semibold">Este pago ya ha sido procesado.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

    </main>

</section>

<!-- CSS para estilos de error y variables médicas -->
 <style>

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        main { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; animation: fadeIn 0.5s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover:hover { transform: translateY(-4px); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .medical-gradient { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9); }
        .card-hover:hover {
            transform: translateY(-4px);
        }
        /* Estilos adicionales para el modal de paciente */

        /* Animación de entrada del modal */
        #modal-agregar-paciente {
            animation: fadeIn 0.3s ease-out;
        }

        #modal-agregar-paciente .inline-block {
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translate3d(0, -100%, 0);
            }
            to {
                opacity: 1;
                transform: translateZ(0);
            }
        }

        /* Estilos para el scroll del modal */
        #modal-agregar-paciente {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Altura máxima para dispositivos móviles */
        @media (max-height: 600px) {
            #modal-agregar-paciente .inline-block {
                margin: 1rem 0;
            }
        }

        /* Estilos para inputs focus mejorados */
        .focus\:ring-2:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        .focus\:ring-green-500:focus {
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
        }

        /* Transición suave para acordeón */
        #content-datos-personales,
        #content-historia-clinica {
            transition: all 0.3s ease-in-out;
        }

        /* Estilos para validación de campos */
        .campo-error {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
        }

        .campo-error:focus {
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5) !important;
        }

        /* Estilos para campos obligatorios */
        input[required]:invalid {
            border-color: #fbbf24;
        }

        input[required]:valid {
            border-color: #10b981;
        }

        /* Hover effect mejorado para botones del acordeón */
        .hover\:bg-blue-100:hover {
            background-color: #dbeafe;
        }

        .hover\:bg-green-100:hover {
            background-color: #dcfce7;
        }

        /* Estilos responsivos para el modal */
        @media (max-width: 768px) {
            #modal-agregar-paciente .inline-block {
                margin: 0.5rem;
                width: calc(100% - 1rem);
            }

            #modal-agregar-paciente .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }

        /* Indicador visual para campos obligatorios */
        label:has(+ input[required])::after,
        label:has(+ select[required])::after {
            content: ' *';
            color: #ef4444;
        }

        /* Estilos para el upload de archivos */
        input[type="file"] {
            padding: 0.5rem !important;
        }

        input[type="file"]::-webkit-file-upload-button {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="file"]::-webkit-file-upload-button:hover {
            background: #e5e7eb;
        }

        /* Estilos para textarea resize */
        textarea {
            resize: vertical;
            min-height: 2.5rem;
        }

        /* Animación de rotación para iconos del acordeón */
        .transform.rotate-180 {
            transform: rotate(180deg);
        }

        .transition-transform {
            transition: transform 0.2s ease-in-out;
        }

        /* Backdrop blur para el modal */
        #modal-agregar-paciente > .flex > .fixed {
            backdrop-filter: blur(4px);
        }

        /* Scroll personalizado para el modal */
        #modal-agregar-paciente::-webkit-scrollbar {
            width: 8px;
        }

        #modal-agregar-paciente::-webkit-scrollbar-track {
            background: transparent;
        }

        #modal-agregar-paciente::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5);
            border-radius: 4px;
        }

        #modal-agregar-paciente::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.7);
        }
        /* Estilos para el checkbox toggle */
        input[type="checkbox"]:checked + div .bg-teal-200 {
            background-color: #14b8a6; /* teal-500 */
        }

        input[type="checkbox"]:checked + div .transform {
            transform: translateX(1rem); /* Mueve el círculo a la derecha */
        }

        input[type="checkbox"]:focus + div {
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.3);
            border-radius: 9999px;
        }

        /* Hover effect */
        label:hover .bg-teal-200 {
            background-color: #99f6e4; /* teal-300 */
        }

        input[type="checkbox"]:checked + div:hover .bg-teal-200 {
            background-color: #0d9488; /* teal-600 */
        }
        /* estilos del select busqueda de paciente*/
         .dropdown-open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-closed {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
        }

        .option-hover:hover {
            background-color: #dbeafe;
        }

        .option-selected {
            background-color: #3b82f6;
            color: white;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .card-hover:hover {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
 </style>

<!-- Script principal de la aplicación -->
<script>
// ==============================
// INICIALIZACIÓN DE CONTEXTOS
// ==============================

// Obtener datos de Django de forma segura
var pacienteDesdeServidor = {% if paciente_json %}{{ paciente_json|safe }}{% else %}null{% endif %};
var medicamentosDesdeServidor = {% if medicamentos_json %}{{ medicamentos_json|safe }}{% else %}[]{% endif %};
var serviciosDesdeServidor = {% if servicios_json %}{{ servicios_json|safe }}{% else %}[]{% endif %};
var modoEdicion = {{ modo_edicion|yesno:"true,false" }};

// Contexto de servicios disponibles
window.serviciosContext = {% if servicios_disponibles_json %}{{ servicios_disponibles_json|safe }}{% else %}[]{% endif %};

// Variables para PayPal
var atencionId = {{ atencion.id|default:"null" }};

// ==============================
// SISTEMA DE ATENCIÓN MÉDICA - CÓDIGO ORGANIZADO
// ==============================

// ==============================
// 1. VARIABLES GLOBALES
// ==============================
let atencionMedica = null;
let pacienteSeleccionado = null;
let searchTimeout = null;
let isSearching = false;

// ==============================
// 2. GESTIÓN DE PESTAÑAS/TABS
// ==============================

/**
 * Función para cambiar de pestaña o tabs
 * @param {string} tabName - Nombre de la pestaña a mostrar
 */
window.showTab = function(tabName) {
    // Ocultar todas las pestañas
    const allTabs = document.querySelectorAll('.tab-content');
    allTabs.forEach(tab => {
        tab.classList.remove('active');
    });

    // Mostrar la pestaña seleccionada
    const selectedTab = document.getElementById('content-' + tabName);
    selectedTab.classList.add('active');

    // Actualizar estilos de los botones - RESETEAR TODOS
    const allButtons = document.querySelectorAll('.tab-button');
    allButtons.forEach(button => {
        // Remover clases activas
        button.classList.remove('border-blue-500', 'border-indigo-500', 'border-purple-500');
        button.classList.remove('text-blue-600', 'text-indigo-600', 'text-purple-600');
        button.classList.remove('bg-blue-50/50', 'bg-indigo-50/50', 'bg-purple-50/50');
        button.classList.remove('dark:bg-blue-900/20', 'dark:bg-indigo-900/20', 'dark:bg-purple-900/20');
        button.classList.remove('dark:text-blue-400', 'dark:text-indigo-400', 'dark:text-purple-400');
        
        // Agregar clases inactivas
        button.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
        
        // Resetear iconos
        const icon = button.querySelector('.w-8');
        if (icon) {
            icon.classList.remove('transform', 'scale-110');
        }
        
        // Remover indicador activo
        const indicator = button.querySelector('.w-2.h-2');
        if (indicator) {
            indicator.remove();
        }
    });

    // Activar el botón seleccionado con colores específicos
    const selectedButton = document.getElementById('tab-' + tabName);
    selectedButton.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
    
    // Aplicar estilos específicos según la pestaña
    if (tabName === 'paciente') {
        selectedButton.classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400', 'bg-blue-50/50', 'dark:bg-blue-900/20');
        // Agregar indicador activo
        const buttonContent = selectedButton.querySelector('.flex.items-center.justify-center.space-x-2');
        if (buttonContent && !buttonContent.querySelector('.w-2.h-2')) {
            const indicator = document.createElement('div');
            indicator.className = 'w-2 h-2 bg-blue-500 rounded-full animate-pulse';
            buttonContent.appendChild(indicator);
        }
    } else if (tabName === 'consultas') {
        selectedButton.classList.add('border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400', 'bg-indigo-50/50', 'dark:bg-indigo-900/20');
        // Agregar indicador activo
        const buttonContent = selectedButton.querySelector('.flex.items-center.justify-center.space-x-2');
        if (buttonContent && !buttonContent.querySelector('.w-2.h-2')) {
            const indicator = document.createElement('div');
            indicator.className = 'w-2 h-2 bg-indigo-500 rounded-full animate-pulse';
            buttonContent.appendChild(indicator);
        }
    } else if (tabName === 'atencion') {
        selectedButton.classList.add('border-purple-500', 'text-purple-600', 'dark:text-purple-400', 'bg-purple-50/50', 'dark:bg-purple-900/20');
        // Agregar indicador activo
        const buttonContent = selectedButton.querySelector('.flex.items-center.justify-center.space-x-2');
        if (buttonContent && !buttonContent.querySelector('.w-2.h-2')) {
            const indicator = document.createElement('div');
            indicator.className = 'w-2 h-2 bg-purple-500 rounded-full animate-pulse';
            buttonContent.appendChild(indicator);
        }
    }
    
    // Escalar el icono del botón activo
    const activeIcon = selectedButton.querySelector('.w-8');
    if (activeIcon) {
        activeIcon.classList.add('transform', 'scale-110');
    }
}

// ==============================
// 3. CLASE PRINCIPAL - GESTOR DE ATENCIÓN MÉDICA
// ==============================

/**
 * Clase principal para procesar la atención médica con sus medicamentos
 */
class GestorAtencionMedica {
    constructor() {
        console.log('🔧 Construyendo GestorAtencionMedica...');

        // Inicializar arrays para medicamentos y servicios
        this.medicamentos = [];
        this.servicios = [];

        // Propiedades para capturar datos del formulario
        this.paciente = '';
        this.presionArterial = '';
        this.pulso = '';
        this.temperatura = '';
        this.frecuenciaRespiratoria = '';
        this.saturacionOxigeno = '';
        this.peso = '';
        this.altura = '';
        this.consultaControl = false;
        this.motivoConsulta = '';
        this.sintomas = '';
        this.examenFisico = '';
        this.diagnostico = [];
        this.tratamiento = '';
        this.examenesEnviados = '';
        this.comentarioAdicional = '';
        setTimeout(() => {
            this.inicializarDiagnosticos();
        }, 100);
        // 🆕 CARGAR MEDICAMENTOS SI ESTÁ EN MODO EDICIÓN
        if (modoEdicion && medicamentosDesdeServidor.length > 0) {
            console.log('💊 Modo edición detectado - Cargando medicamentos existentes...');
            this.cargarMedicamentosExistentes(medicamentosDesdeServidor);
        }

        // 🆕 CARGAR SERVICIOS SI ESTÁ EN MODO EDICIÓN
        if (modoEdicion && serviciosDesdeServidor.length > 0) {
            console.log('🏥 Modo edición detectado - Cargando servicios existentes...');
            this.cargarServiciosExistentes(serviciosDesdeServidor);
        }

        // Inicializar gestión de servicios adicionales
        setTimeout(() => {
            this.inicializarServiciosAdicionales();
        }, 100);

    }

   /**
     * Carga los medicamentos existentes directamente en la lista y actualiza la tabla
     * Se ejecuta solo en modo edición
     */
    cargarMedicamentosExistentes(medicamentos) {
        console.log('📋 Cargando', medicamentos.length, 'medicamentos en la lista...');

        // Recorrer cada medicamento del servidor
        medicamentos.forEach((medicamentoData, index) => {
            console.log(`💊 Procesando medicamento ${index + 1}:`, medicamentoData);

            // Crear objeto medicamento con la misma estructura que usa agregarMedicamento()
            const medicamentoParaLista = {
                id: medicamentoData.id,
                medicamento: medicamentoData.nombre,
                cantidad: medicamentoData.cantidad,
                prescripcion: medicamentoData.prescripcion,
                duracion: medicamentoData.duracion,
                frecuencia: medicamentoData.frecuencia
            };

            // Agregar directamente al array medicamentos
            this.medicamentos.push(medicamentoParaLista);

            console.log(`✅ Medicamento ${index + 1} agregado a la lista:`, medicamentoParaLista);
        });

        // Actualizar la tabla HTML una sola vez al final
        // Usar setTimeout para asegurar que el DOM esté listo
        setTimeout(() => {
            this.actualizarTablaMedicamentos();
            console.log('🎉 Tabla actualizada! Total medicamentos:', this.medicamentos.length);
        }, 200);
    }

    /**
     * Método seguro para obtener elemento por ID
     * @param {string} id - ID del elemento
     * @returns {Element|null} - Elemento encontrado o null
     */
    obtenerElementoSeguro(id) {
        const elemento = document.getElementById(id);
        if (!elemento) {
            console.warn(`⚠️ Elemento no encontrado: ${id}`);
        }
        return elemento;
    }

    /**
     * Método seguro para obtener valor de un elemento
     * @param {string} id - ID del elemento
     * @param {string} valorPorDefecto - Valor por defecto si no existe
     * @returns {string} - Valor del elemento
     */
    obtenerValorSeguro(id, valorPorDefecto = '') {
        const elemento = this.obtenerElementoSeguro(id);
        return elemento ? elemento.value : valorPorDefecto;
    }

    /**
     * Método seguro para verificar checkbox
     * @param {string} id - ID del checkbox
     * @returns {boolean} - Estado del checkbox
     */
    obtenerCheckboxSeguro(id) {
        const elemento = this.obtenerElementoSeguro(id);
        return elemento ? elemento.checked : false;
    }

    // ============================================
    // 3.2 GESTIÓN DE MEDICAMENTOS
    // ============================================

    /**
     * Método para actualizar la tabla de medicamentos
     */
    actualizarTablaMedicamentos() {
        console.log('🔄 Actualizando tabla de medicamentos...');

        const tbody = this.obtenerElementoSeguro('medicamentos-table');

        if (!tbody) {
            console.error('❌ No se encontró la tabla con ID: medicamentos-table');
            return;
        }

        // Limpiar tabla
        tbody.innerHTML = '';

        // Agregar cada medicamento
        this.medicamentos.forEach((med, index) => {
            const fila = document.createElement('tr');
            fila.className = 'bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200';

            fila.innerHTML = `
                <td class="py-4 px-4 text-gray-800 dark:text-gray-200 font-medium">${med.medicamento}</td>
                <td class="py-4 px-4 text-gray-600 dark:text-gray-300">${med.cantidad}</td>
                <td class="py-4 px-4 text-gray-600 dark:text-gray-300">${med.prescripcion}</td>
                <td class="py-4 px-4 text-gray-600 dark:text-gray-300">${med.duracion}</td>
                <td class="py-4 px-4 text-gray-600 dark:text-gray-300">${med.frecuencia}</td>
                <td class="py-4 px-4">
                    <button onclick="eliminarMedicamentoSeguro(${index})"
                            class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors duration-200 shadow-md hover:shadow-lg">
                        <i class="fas fa-trash mr-1"></i>Eliminar
                    </button>
                </td>
            `;

            tbody.appendChild(fila);
        });

        console.log('✅ Tabla actualizada. Total medicamentos:', this.medicamentos.length);
    }

    /**
     * Método para limpiar campos de medicamentos
     */
    limpiarCamposMedicamentos() {
        const campos = ['medicamento-select', 'cantidad-input', 'prescripcion-input', 'duracion-input', 'frecuencia-input'];

        campos.forEach(id => {
            const elemento = this.obtenerElementoSeguro(id);
            if (elemento) {
                elemento.value = '';
            }
        });
    }

    /**
     * Método para eliminar medicamento
     * @param {number} index - Índice del medicamento a eliminar
     */
    eliminarMedicamento(index) {
        if (confirm('¿Está seguro de que desea eliminar este medicamento?')) {
            this.medicamentos.splice(index, 1);
            this.actualizarTablaMedicamentos();
            console.log('🗑️ Medicamento eliminado. Total restante:', this.medicamentos.length);
        }
    }

    // ============================================
    // 3.2.1 GESTIÓN DE SERVICIOS ADICIONALES
    // ============================================

    /**
     * Carga los servicios existentes directamente en la lista
     * Se ejecuta solo en modo edición
     */
    cargarServiciosExistentes(servicios) {
        console.log('🏥 Cargando', servicios.length, 'servicios en la lista...');

        // Recorrer cada servicio del servidor
        servicios.forEach((servicioData, index) => {
            console.log(`🏥 Procesando servicio ${index + 1}:`, servicioData);

            // Crear objeto servicio con la misma estructura
            const servicioParaLista = {
                id: servicioData.id,
                nombre: servicioData.nombre,
                cantidad: servicioData.cantidad,
                observaciones: servicioData.observaciones,
                precio: servicioData.precio
            };

            // Agregar directamente al array servicios
            this.servicios.push(servicioParaLista);

            console.log(`✅ Servicio ${index + 1} agregado a la lista:`, servicioParaLista);
        });

        console.log('🎉 Servicios cargados! Total servicios:', this.servicios.length);
    }

    /**
     * Inicializar la gestión de servicios adicionales
     */
    inicializarServiciosAdicionales() {
        console.log('🏥 Inicializando gestión de servicios adicionales...');

        // Obtener elementos del DOM
        const addButton = document.getElementById('add-servicio-button');
        const container = document.getElementById('formset-servicios-container');

        if (!addButton || !container) {
            console.warn('⚠️ Elementos de servicios no encontrados');
            return;
        }

        // Configurar evento para agregar servicio
        addButton.addEventListener('click', () => {
            this.agregarFormularioServicio();
        });

        // Configurar eventos para eliminar servicios existentes
        this.configurarEventosEliminarServicios();

        console.log('✅ Gestión de servicios inicializada');
    }

    /**
     * Agregar un nuevo formulario de servicio al formset
     */
    agregarFormularioServicio() {
        console.log('🏥 Agregando nuevo formulario de servicio...');

        const container = document.getElementById('formset-servicios-container');
        const managementForm = container.querySelector('input[name$="-TOTAL_FORMS"]');
        
        if (!managementForm) {
            console.error('❌ Management form no encontrado');
            return;
        }

        const totalForms = parseInt(managementForm.value);
        const newFormIndex = totalForms;

        // Crear el HTML del nuevo formulario
        const nuevoFormulario = this.crearFormularioServicioHTML(newFormIndex);

        // Insertar antes del botón de agregar
        const addButton = document.getElementById('add-servicio-button');
        addButton.parentNode.insertBefore(nuevoFormulario, addButton);

        // Actualizar el management form
        managementForm.value = totalForms + 1;

        // Configurar evento de eliminar para el nuevo formulario
        this.configurarEventoEliminarServicio(nuevoFormulario);

        console.log('✅ Formulario de servicio agregado. Total forms:', totalForms + 1);
    }

    /**
     * Crear el HTML de un formulario de servicio
     */
    crearFormularioServicioHTML(index) {
        const div = document.createElement('div');
        div.className = 'formset-row-servicio bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl mb-4 border border-gray-200 dark:border-gray-700';
        
        // Crear el HTML dinámicamente sin usar template literals de Django
        div.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Servicio *</label>
                    <select name="servicios-${index}-servicio" id="id_servicios-${index}-servicio" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" required>
                        <option value="">Seleccione servicio...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cantidad *</label>
                    <input type="number" name="servicios-${index}-cantidad" id="id_servicios-${index}-cantidad" min="1" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" placeholder="1" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Observaciones</label>
                    <textarea name="servicios-${index}-observaciones" id="id_servicios-${index}-observaciones" rows="1" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" placeholder="Observaciones adicionales..."></textarea>
                </div>
            </div>
            <button type="button" class="delete-row-button mt-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors duration-200">Eliminar</button>
        `;

        // Poblar el select con los servicios disponibles
        const select = div.querySelector('select');
        this.poblarSelectServicios(select);

        return div;
    }

    /**
     * Configurar eventos de eliminar para servicios existentes
     */
    configurarEventosEliminarServicios() {
        const deleteButtons = document.querySelectorAll('.formset-row-servicio .delete-row-button');
        deleteButtons.forEach(button => {
            this.configurarEventoEliminarServicio(button.closest('.formset-row-servicio'));
        });
    }

    /**
     * Configurar evento de eliminar para un formulario específico
     */
    configurarEventoEliminarServicio(formulario) {
        const deleteButton = formulario.querySelector('.delete-row-button');
        if (deleteButton) {
            deleteButton.addEventListener('click', () => {
                if (confirm('¿Está seguro de que desea eliminar este servicio?')) {
                    this.eliminarFormularioServicio(formulario);
                }
            });
        }
    }

    /**
     * Eliminar un formulario de servicio
     */
    eliminarFormularioServicio(formulario) {
        console.log('🗑️ Eliminando formulario de servicio...');

        const container = document.getElementById('formset-servicios-container');
        const managementForm = container.querySelector('input[name$="-TOTAL_FORMS"]');
        
        if (managementForm) {
            const totalForms = parseInt(managementForm.value);
            managementForm.value = Math.max(0, totalForms - 1);
        }

        formulario.remove();
        console.log('✅ Formulario de servicio eliminado');
    }

    /**
     * Recopilar datos de servicios del formset
     */
    recopilarDatosServicios() {
        console.log('🏥 Recopilando datos de servicios...');

        const servicios = [];
        const formularios = document.querySelectorAll('.formset-row-servicio');

        formularios.forEach((formulario, index) => {
            const servicioSelect = formulario.querySelector('select[name*="-servicio"]');
            const cantidadInput = formulario.querySelector('input[name*="-cantidad"]');
            const observacionesTextarea = formulario.querySelector('textarea[name*="-observaciones"]');

            if (servicioSelect && cantidadInput) {
                const servicioId = servicioSelect.value;
                const cantidad = cantidadInput.value;
                const observaciones = observacionesTextarea ? observacionesTextarea.value : '';

                if (servicioId && cantidad) {
                    servicios.push({
                        id: parseInt(servicioId),
                        cantidad: parseInt(cantidad),
                        observaciones: observaciones.trim()
                    });
                }
            }
        });

        console.log('📋 Servicios recopilados:', servicios);
        return servicios;
    }

    // ============================================
    // 3.3 GESTIÓN DE DIAGNÓSTICOS
    // ============================================

    /**
 * Método para manejar selección de diagnósticos desde select múltiple
 */
agregarDiagnostico() {
    console.log('🔄 Función agregarDiagnostico() llamada');

    const diagnosticoSelect = this.obtenerElementoSeguro('id_diagnostico');
    const diagnosticoLista = this.obtenerElementoSeguro('diagnosticos-lista');

    if (!diagnosticoSelect || !diagnosticoLista) {
        console.error('❌ No se encontraron los elementos de diagnóstico');
        alert('Error: Elementos de diagnóstico no encontrados en la página');
        return;
    }

    // Limpiar la lista visual actual
    diagnosticoLista.innerHTML = '';

    // Obtener todas las opciones seleccionadas
    const opcionesSeleccionadas = Array.from(diagnosticoSelect.selectedOptions);

    if (opcionesSeleccionadas.length === 0) {
        console.log('ℹ️ No hay diagnósticos seleccionados');
        return;
    }

    // Crear spans visuales para cada diagnóstico seleccionado
    opcionesSeleccionadas.forEach(option => {
        const span = document.createElement('span');
        span.className = 'bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs mr-2 mb-2 inline-block';
        span.textContent = option.text;

        // Agregar botón de eliminar
        const btnEliminar = document.createElement('button');
        btnEliminar.innerHTML = '×';
        btnEliminar.className = 'ml-1 text-red-500 hover:text-red-700';
        btnEliminar.onclick = () => {
            // Deseleccionar la opción del select
            option.selected = false;
            // Remover el span visual
            span.remove();
            console.log('🗑️ Diagnóstico eliminado:', option.text);
        };
        span.appendChild(btnEliminar);

        diagnosticoLista.appendChild(span);
    });

    console.log('✅ Diagnósticos actualizados:', opcionesSeleccionadas.length);
}

/**
 * Método para inicializar listeners de diagnósticos
 */
inicializarDiagnosticos() {
    const diagnosticoSelect = this.obtenerElementoSeguro('id_diagnostico');

    if (diagnosticoSelect) {
        // Agregar listener para cambios en el select múltiple
        diagnosticoSelect.addEventListener('change', () => {
            this.agregarDiagnostico();
        });

        console.log('✅ Listeners de diagnósticos inicializados');
    }
}
    // ============================================
    // 3.4 GRABACIÓN Y ENVÍO DE DATOS
    // ============================================

    /**
     * Método para capturar todos los datos del formulario
     */
    grabarAtencion() {
        console.log('💾 Iniciando proceso de grabación...');

        try {
            // Capturar datos de identificación
            this.paciente = this.obtenerValorSeguro('id_paciente', '1');

            // Capturar signos vitales y mediciones
            this.presionArterial = this.obtenerValorSeguro('id_presion_arterial');
            this.pulso = this.obtenerValorSeguro('id_pulso');
            this.temperatura = this.obtenerValorSeguro('id_temperatura');
            this.frecuenciaRespiratoria = this.obtenerValorSeguro('id_frecuencia_respiratoria');
            this.saturacionOxigeno = this.obtenerValorSeguro('id_saturacion_oxigeno');
            this.peso = this.obtenerValorSeguro('id_peso');
            this.altura = this.obtenerValorSeguro('id_altura');
            this.consultaControl = this.obtenerCheckboxSeguro('id_consulta_control');

            // Capturar evaluación clínica
            this.motivoConsulta = this.obtenerValorSeguro('id_motivo_consulta');
            this.sintomas = this.obtenerValorSeguro('id_sintomas');
            this.examenFisico = this.obtenerValorSeguro('id_examen_fisico');

            // Capturar diagnósticos seleccionados
            this.diagnostico = [];
            const diagnosticoElement = this.obtenerElementoSeguro("id_diagnostico");

            if (diagnosticoElement?.selectedOptions?.length > 0) {
                // Convertir a array y mapear los valores
                this.diagnostico = Array.from(diagnosticoElement.selectedOptions)
                    .map(option => {
                        const id = parseInt(option.value);
                        return isNaN(id) ? null : id;
                    })
                    .filter(id => id !== null); // Filtrar valores inválidos
            }

            // Capturar plan terapéutico
            this.tratamiento = this.obtenerValorSeguro('id_tratamiento');
            this.examenesEnviados = this.obtenerValorSeguro('id_examenes_enviados');
            this.comentarioAdicional = this.obtenerValorSeguro('id_comentario_adicional');

            // Validar campos obligatorios
            const errores = this.validarCamposObligatorios();
            if (errores.length > 0) {
                alert('Por favor, complete los siguientes campos obligatorios:\n' + errores.join('\n'));
                return;
            }

            // Preparar objeto con todos los datos
            const datosAtencion = this.obtenerDatosCompletos();
            console.log('📦 Datos preparados para envío:', datosAtencion);

            // Enviar datos al backend
            this.enviarDatosAlBackend(datosAtencion);

            console.log('✅ Proceso de grabación iniciado');
            window.location.href = "{% url 'doctor:atencion_list' %}"

        } catch (error) {
            console.error('❌ Error en grabarAtencion:', error);
            alert('Error al procesar los datos: ' + error.message);
        }
    }

    /**
     * Método para enviar datos al backend usando fetch
     * @param {Object} datos - Datos de la atención médica
     */
    async enviarDatosAlBackend(datos) {
        try {
            // Mostrar indicador de carga
            this.mostrarIndicadorCarga(true);

            // URL del endpoint - CAMBIAR POR TU URL REAL
            //const url = "{% url 'doctor:atencion_create' %}"
            let url = window.location.pathname.trim()

            console.log('🚀 EJECUTANDO FETCH - Enviando datos al backend...');
            console.log('📍 URL:', url);
            console.log('📦 Datos a enviar:', datos);

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(datos)
            });

            // Ocultar indicador de carga
            this.mostrarIndicadorCarga(false);

            if (response.ok) {
                const resultado = await response.json();
                console.log('✅ FETCH EXITOSO - Respuesta del servidor:', resultado);

                this.mostrarMensajeExito(resultado);
                this.limpiarFormulario();

            } else {
                const error = await response.text();
                console.error('❌ FETCH ERROR - Error del servidor:', response.status, error);
                this.mostrarMensajeError(`Error del servidor (${response.status}): ${error}`);
            }

        } catch (error) {
            this.mostrarIndicadorCarga(false);
            console.error('❌ FETCH FALLÓ - Error de conexión:', error);

            if (error instanceof TypeError && error.message.includes('fetch')) {
                console.log('🔌 Sin conexión - Ofreciendo modo offline...');
                this.manejarErrorConexion(datos);
            } else {
                this.mostrarMensajeError('Error inesperado: ' + error.message);
            }
        }
    }

    // ============================================
    // 3.5 MÉTODOS DE INTERFAZ DE USUARIO
    // ============================================

    /**
     * Método para mostrar indicador de carga
     * @param {boolean} mostrar - Si mostrar o no el indicador
     */
    mostrarIndicadorCarga(mostrar) {
        const botonGuardar = document.querySelector('button[type="submit"]');

        if (!botonGuardar) {
            console.warn('⚠️ Botón de guardar no encontrado');
            return;
        }

        if (mostrar) {
            botonGuardar.disabled = true;
            botonGuardar.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Guardando...
            `;
        } else {
            botonGuardar.disabled = false;
            botonGuardar.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Guardar Atención Médica</span>
            `;
        }
    }

    /**
     * Método para mostrar mensaje de éxito
     * @param {Object} resultado - Resultado del servidor
     */
    mostrarMensajeExito(resultado) {
        const mensaje = resultado.message || 'Atención médica guardada exitosamente';
        const id = resultado.id || 'N/A';

        alert(`✅ ${mensaje}\n\n` +
              `ID de Atención: ${id}\n` +
              `Medicamentos: ${this.medicamentos.length}\n` +
              `Diagnósticos: ${this.diagnostico.length}\n` +
              `Fecha: ${new Date().toLocaleString()}`);
    }

    /**
     * Método para mostrar mensaje de error
     * @param {string} mensaje - Mensaje de error
     */
    mostrarMensajeError(mensaje) {
        alert(`❌ Error al guardar:\n\n${mensaje}\n\nRevise la conexión e intente nuevamente.`);
    }

    /**
     * Método para manejar errores de conexión
     * @param {Object} datos - Datos a guardar offline
     */
    manejarErrorConexion(datos) {
        const guardarOffline = confirm(
            '❌ No se pudo conectar con el servidor.\n\n' +
            '¿Desea guardar los datos localmente?\n\n' +
            '(Los datos se enviarán cuando se restaure la conexión)'
        );

        if (guardarOffline) {
            this.guardarDatosOffline(datos);
            alert('💾 Datos guardados localmente.\n\nSe enviarán automáticamente cuando se restaure la conexión.');
        }
    }

    /**
     * Método para guardar datos offline
     * @param {Object} datos - Datos a guardar
     */
    guardarDatosOffline(datos) {
        try {
            const datosOffline = JSON.parse(localStorage.getItem('atencionesOffline') || '[]');
            datosOffline.push({
                ...datos,
                fechaGuardadoOffline: new Date().toISOString(),
                id_temporal: 'offline_' + Date.now()
            });
            localStorage.setItem('atencionesOffline', JSON.stringify(datosOffline));
            console.log('💾 Datos guardados offline:', datos);
        } catch (error) {
            console.error('❌ Error al guardar offline:', error);
        }
    }

    // ============================================
    // 3.6 UTILIDADES Y VALIDACIONES
    // ============================================

    /**
     * Método para limpiar el formulario
     */
    limpiarFormulario() {
        const campos = [
            'id_presion_arterial', 'id_pulso', 'id_temperatura', 'id_frecuencia_respiratoria',
            'id_saturacion_oxigeno', 'id_peso', 'id_altura', 'id_motivo_consulta',
            'id_sintomas', 'id_examen_fisico', 'id_tratamiento', 'id_examenes_enviados',
            'id_comentario_adicional'
        ];

        campos.forEach(id => {
            const elemento = this.obtenerElementoSeguro(id);
            if (elemento) {
                elemento.value = '';
            }
        });

        // Limpiar checkbox
        const checkbox = this.obtenerElementoSeguro('id_consulta_control');
        if (checkbox) {
            checkbox.checked = false;
        }

        // Limpiar diagnósticos
        const diagnosticoLista = this.obtenerElementoSeguro('diagnosticos-lista');
        const diagnosticoSelect = this.obtenerElementoSeguro('id_diagnostico');

        if (diagnosticoLista) diagnosticoLista.innerHTML = '';
        if (diagnosticoSelect) diagnosticoSelect.innerHTML = '';

        // Limpiar medicamentos
        this.medicamentos = [];
        this.actualizarTablaMedicamentos();

        console.log('🧹 Formulario limpiado');
    }

    /**
     * Método para validar campos obligatorios
     * @returns {Array} - Array de errores encontrados
     */
    validarCamposObligatorios() {
        const errores = [];

        // Validar campos básicos
        if (!this.motivoConsulta.trim()) errores.push('- Motivo de Consulta');
        if (!this.sintomas.trim()) errores.push('- Síntomas');
        if (this.diagnostico.length === 0) errores.push('- Diagnósticos');
        if (!this.tratamiento.trim()) errores.push('- Plan de Tratamiento');

        // NO validar medicamentos en el formulario si ya hay medicamentos agregados a la lista
        // Solo validar si el usuario está intentando agregar un medicamento pero no completó los campos
        const medicamentoSeleccionado = document.getElementById('medicamento-select').value;
        const cantidadIngresada = document.getElementById('cantidad-input').value;
        const prescripcionIngresada = document.getElementById('prescripcion-input').value;
        const duracionIngresada = document.getElementById('duracion-input').value;
        const frecuenciaIngresada = document.getElementById('frecuencia-input').value;

        // Solo validar si hay ALGÚN campo de medicamento lleno pero no todos
        const hayDatosParciales = medicamentoSeleccionado || cantidadIngresada || prescripcionIngresada || duracionIngresada || frecuenciaIngresada;
        const todoCompleto = medicamentoSeleccionado && cantidadIngresada && prescripcionIngresada && duracionIngresada && frecuenciaIngresada;

        if (hayDatosParciales && !todoCompleto) {
            errores.push('- Complete todos los campos del medicamento o límpielos para continuar');
        }

        return errores;
    }

    /**
     * Método para agregar medicamento
     */
    agregarMedicamento() {
        console.log('💊 Agregando medicamento...');

        // Obtener valores de los campos de forma segura
        const select = document.getElementById('medicamento-select');
        const medicamento = select.options[select.selectedIndex]?.text;
        const cantidad = this.obtenerValorSeguro('cantidad-input');
        const prescripcion = this.obtenerValorSeguro('prescripcion-input');
        const duracion = this.obtenerValorSeguro('duracion-input');
        const frecuencia = this.obtenerValorSeguro('frecuencia-input');

        // Validar que todos los campos estén llenos
        if (!medicamento || !cantidad || !prescripcion || !duracion || !frecuencia) {
            alert('Por favor, complete todos los campos del medicamento.');
            return;
        }

        // Crear objeto medicamento
        const nuevoMedicamento = {
            id: select.value,
            medicamento: medicamento,
            cantidad: parseInt(cantidad),
            prescripcion: prescripcion,
            duracion: parseInt(duracion),
            frecuencia: parseInt(frecuencia)
        };

        // Agregar a la lista
        this.medicamentos.push(nuevoMedicamento);

        // Actualizar la tabla
        this.actualizarTablaMedicamentos();

        // Limpiar campos
        this.limpiarCamposMedicamentos();

        console.log('✅ Medicamento agregado:', nuevoMedicamento);
        console.log('📊 Total medicamentos:', this.medicamentos.length);
    }

    /**
     * Poblar un select con los servicios disponibles
     */
    poblarSelectServicios(select) {
        // Obtener los servicios del contexto global
        const serviciosContext = window.serviciosContext || [];
        
        serviciosContext.forEach(servicio => {
            const option = document.createElement('option');
            option.value = servicio.id;
            option.textContent = servicio.nombre;
            option.title = `${servicio.descripcion || ''} - $${servicio.precio}`;
            select.appendChild(option);
        });

        if (serviciosContext.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.disabled = true;
            option.textContent = 'No hay servicios disponibles';
            select.appendChild(option);
        }
    }

    /**
     * Método para obtener todos los datos estructurados con conversiones numéricas
     * @returns {Object} - Objeto con todos los datos de la atención
     */
     obtenerDatosCompletos() {
        // Función auxiliar para convertir a número o null
        const convertirANumero = (valor) => {
            if (!valor || valor === '') return null;
            const numero = parseFloat(valor);
            return isNaN(numero) ? null : numero;
        };

        // Función auxiliar para convertir a entero o null
        const convertirAEntero = (valor) => {
            if (!valor || valor === '') return null;
            const numero = parseInt(valor);
            return isNaN(numero) ? null : numero;
        };

        // Procesar medicamentos con conversiones numéricas
        const medicamentosProcesados = this.medicamentos.map(med => ({
            id: convertirAEntero(med.id),
            medicamento: med.medicamento,
            cantidad: convertirAEntero(med.cantidad),
            prescripcion: med.prescripcion,
            duracion: convertirAEntero(med.duracion),
            frecuencia: convertirAEntero(med.frecuencia)
        }));

        // Recopilar servicios del formset
        const servicios = this.recopilarDatosServicios();

        return {
            paciente: convertirAEntero(this.paciente),
            signosVitales: {
                presionArterial: this.presionArterial, // Se mantiene como string (ej: "120/80")
                pulso: convertirAEntero(this.pulso),
                temperatura: convertirANumero(this.temperatura),
                frecuenciaRespiratoria: convertirAEntero(this.frecuenciaRespiratoria),
                saturacionOxigeno: convertirANumero(this.saturacionOxigeno),
                peso: convertirANumero(this.peso),
                altura: convertirANumero(this.altura),
                consultaControl: Boolean(this.consultaControl)
            },
            evaluacionClinica: {
                motivoConsulta: this.motivoConsulta,
                sintomas: this.sintomas,
                examenFisico: this.examenFisico,
                diagnostico: this.diagnostico
            },
            planTerapeutico: {
                tratamiento: this.tratamiento,
                examenesEnviados: this.examenesEnviados,
                comentarioAdicional: this.comentarioAdicional
            },
            medicamentos: medicamentosProcesados,
            servicios: servicios,
            fechaAtencion: new Date().toISOString(),
            totalMedicamentos: this.medicamentos.length,
            totalDiagnosticos: this.diagnostico.length,
            totalServicios: servicios.length
        };
     }

    /**
     * Método para mostrar datos
     */
    verDatos() {
        const url = "/admin/core/medicamento/add/?_to_field=id&_popup=1";
        window.open(url, "_blank", "width=800,height=600,resizable=yes,scrollbars=yes");
    }
}

// ==============================
// 4. SELECTOR DE PACIENTES
// ==============================

/**
 * Elementos DOM para el selector de pacientes
 */
let searchInput, dropdown, pacientesList, loadingIndicator, searchIcon, clearButton, noResults, minCharsMessage, datosContainer, noMensaje;

/**
 * Función para manejar el input de búsqueda
 * @param {Event} e - Evento del input
 */
function handleSearchInput(e) {
    const query = e.target.value.trim();

    // Mostrar/ocultar botón de limpiar
    if (query.length > 0) {
        clearButton.classList.remove('hidden');
        searchIcon.classList.add('hidden');
    } else {
        clearButton.classList.add('hidden');
        searchIcon.classList.remove('hidden');
        ocultarDropdown();
        return;
    }

    // Limpiar timeout anterior
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }

    // Configurar nuevo timeout
    searchTimeout = setTimeout(() => {
        if (query.length >= 3) {
            buscarPacientes(query);
        } else if (query.length > 0) {
            mostrarMensajeMinCaracteres();
        } else {
            ocultarDropdown();
        }
    }, 300); // Debounce de 300ms
}

/**
 * Función para manejar el foco del input
 */
function handleInputFocus() {
    const query = searchInput.value.trim();
    if (query.length >= 3) {
        mostrarDropdown();
    } else if (query.length > 0) {
        mostrarMensajeMinCaracteres();
    }
}

/**
 * Función para manejar cuando se pierde el foco
 */
function handleInputBlur() {
    // Pequeño delay para permitir clicks en el dropdown
    setTimeout(() => {
        if (!dropdown.matches(':hover')) {
            ocultarDropdown();
        }
    }, 200);
}

/**
 * Función para manejar clicks en el documento
 * @param {Event} e - Evento del click
 */
function handleDocumentClick(e) {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        ocultarDropdown();
    }
}

/**
 * Función para buscar pacientes en el backend
 * @param {string} query - Término de búsqueda
 */
async function buscarPacientes(query) {
    if (isSearching) return;

    isSearching = true;
    mostrarIndicadorCarga();

    try {
        // Construir URL con parámetros
        const url = new URL(window.location.origin + '/core/paciente_find/');
        url.searchParams.append('q', query);

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        mostrarResultados(data.pacientes || []);

    } catch (error) {
        console.error('Error al buscar pacientes:', error);
        mostrarError('Error al buscar pacientes. Por favor, intente nuevamente.');
    } finally {
        isSearching = false;
        ocultarIndicadorCarga();
    }
}

/**
 * Función para mostrar los resultados de búsqueda
 * @param {Array} pacientes - Lista de pacientes encontrados
 */
function mostrarResultados(pacientes) {
    pacientesList.innerHTML = '';

    if (pacientes.length === 0) {
        noResults.classList.remove('hidden');
        minCharsMessage.classList.add('hidden');
    } else {
        noResults.classList.add('hidden');
        minCharsMessage.classList.add('hidden');

        pacientes.forEach(paciente => {
            const option = crearOpcionPaciente(paciente);
            pacientesList.appendChild(option);
        });
    }

    mostrarDropdown();
}

/**
 * Función para crear una opción de paciente
 * @param {Object} paciente - Datos del paciente
 * @returns {HTMLElement} - Elemento DOM de la opción
 */
function crearOpcionPaciente(paciente) {
    const option = document.createElement('div');
    option.className = 'px-4 py-3 cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors duration-200';
    option.setAttribute('data-paciente-id', paciente.id);

    option.innerHTML = `
        <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center text-white text-lg font-bold shadow-lg">
                ${(paciente.nombres?.charAt(0) || '') + (paciente.apellidos?.charAt(0) || '')}
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-base font-semibold text-gray-900 dark:text-white">
                    ${paciente.nombres || ''} ${paciente.apellidos || ''}
                </div>
                <div class="flex items-center space-x-3 mt-1">
                    <span class="inline-flex items-center px-2 py-1 rounded-md bg-blue-100 dark:bg-blue-900/50 text-xs font-medium text-blue-700 dark:text-blue-300">
                        <i class="fas fa-id-card mr-1"></i>
                        ${paciente.cedula_ecuatoriana || paciente.dni || 'No disponible'}
                    </span>
                    <span class="inline-flex items-center text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-phone mr-1"></i>
                        ${paciente.telefono || 'No disponible'}
                    </span>
                </div>
            </div>
            <div class="flex-shrink-0">
                <i class="fas fa-chevron-right text-gray-400 dark:text-gray-600"></i>
            </div>
        </div>
    `;

    option.addEventListener('click', () => seleccionarPaciente(paciente));

    return option;
}

/**
 * Función para seleccionar un paciente
 * @param {Object} paciente - Datos del paciente seleccionado
 */
function seleccionarPaciente(paciente) {
    pacienteSeleccionado = paciente;

    // Actualizar el input
    searchInput.value = `${paciente.id} - ${paciente.nombres} ${paciente.apellidos} - CI: ${paciente.cedula_ecuatoriana || paciente.dni}`;
    document.getElementById('id_paciente').value=paciente.id
    // Ocultar dropdown
    ocultarDropdown();

    // Cargar datos del paciente
    cargarDatosPaciente(paciente);
    cargarConsultas(paciente.atenciones);
}

/**
 * Función para cargar los datos del paciente en la interfaz
 * @param {Object} paciente - Datos del paciente
 */
function cargarDatosPaciente(paciente) {
    // Calcular edad
    const edad = calcularEdad(paciente.fecha_nacimiento);

    // Actualizar información personal
    document.getElementById('paciente-nombre').textContent =
        `${paciente.nombres || ''} ${paciente.apellidos || ''}`;
    
    // Manejar foto del paciente con fallback mejorado
    const fotoElement = document.getElementById('paciente-foto');
    const iconElement = fotoElement.nextElementSibling;
    
    if (paciente.foto_url && paciente.foto_url !== '' && paciente.foto_url !== 'null') {
        fotoElement.src = paciente.foto_url;
        fotoElement.style.display = 'block';
        iconElement.style.display = 'none';
        fotoElement.onerror = function() {
            this.style.display = 'none';
            iconElement.style.display = 'flex';
        };
    } else {
        fotoElement.style.display = 'none';
        iconElement.style.display = 'flex';
    }
    
    document.getElementById('paciente-telefono').textContent = paciente.telefono || 'No disponible';
    document.getElementById('paciente-direccion').textContent = paciente.direccion || 'No disponible';
    document.getElementById('paciente-email').textContent = paciente.email || 'No disponible';
    document.getElementById('paciente-edad').textContent = edad;
    document.getElementById('paciente-cedula').textContent =
        `CI: ${paciente.cedula_ecuatoriana || paciente.dni || 'No disponible'}`;

    // Datos fijos de la nueva atención - Manejar foto con fallback
    const foto2Element = document.getElementById('paciente-foto2');
    const icon2Element = foto2Element.nextElementSibling;
    
    if (paciente.foto_url && paciente.foto_url !== '' && paciente.foto_url !== 'null') {
        foto2Element.src = paciente.foto_url;
        foto2Element.style.display = 'block';
        icon2Element.style.display = 'none';
        foto2Element.onerror = function() {
            this.style.display = 'none';
            icon2Element.style.display = 'flex';
        };
    } else {
        foto2Element.style.display = 'none';
        icon2Element.style.display = 'flex';
    }
    
    document.getElementById('paciente-edad2').textContent = edad;
    document.getElementById('paciente-nombre2').textContent =
        `${paciente.nombres || ''} ${paciente.apellidos || ''}`;
    document.getElementById('id_paciente').value = paciente.id;

    // Actualizar historia clínica
    document.getElementById('antecedentes-personales').value = paciente.antecedentes_personales || '';
    document.getElementById('antecedentes-quirurgicos').value = paciente.antecedentes_quirurgicos || '';
    document.getElementById('antecedentes-familiares').value = paciente.antecedentes_familiares || '';
    document.getElementById('alergias').value = paciente.alergias || '';
    document.getElementById('medicamentos-actuales').value = paciente.medicamentos_actuales || '';
    document.getElementById('habitos-toxicos').value = paciente.habitos_toxicos || '';
    document.getElementById('vacunas').value = paciente.vacunas || '';
    document.getElementById('antecedentes-gineco').value = paciente.antecedentes_gineco_obstetricos || '';

    // Mostrar contenedor de datos y ocultar mensaje
    datosContainer.classList.remove('hidden');
    noMensaje.classList.add('hidden');
}

/**
 * Función para calcular la edad
 * @param {string} fechaNacimiento - Fecha de nacimiento
 * @returns {string} - Edad calculada
 */
function calcularEdad(fechaNacimiento) {
    if (!fechaNacimiento) return 'No disponible';

    const hoy = new Date();
    const nacimiento = new Date(fechaNacimiento);
    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const meses = hoy.getMonth() - nacimiento.getMonth();

    if (meses < 0 || (meses === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
    }

    return `${edad} años`;
}

/**
 * Función para limpiar la selección de paciente
 */
function limpiarSeleccion() {
    searchInput.value = '';
    pacienteSeleccionado = null;
    clearButton.classList.add('hidden');
    searchIcon.classList.remove('hidden');
    ocultarDropdown();

    // Ocultar datos del paciente
    datosContainer.classList.add('hidden');
    noMensaje.classList.remove('hidden');

    // Enfocar el input
    searchInput.focus();
}

// Funciones auxiliares para el dropdown
function mostrarDropdown() {
    dropdown.classList.remove('dropdown-closed');
    dropdown.classList.add('dropdown-open');
}

function ocultarDropdown() {
    dropdown.classList.remove('dropdown-open');
    dropdown.classList.add('dropdown-closed');
}

function mostrarMensajeMinCaracteres() {
    pacientesList.innerHTML = '';
    noResults.classList.add('hidden');
    minCharsMessage.classList.remove('hidden');
    mostrarDropdown();
}

function mostrarIndicadorCarga() {
    loadingIndicator.classList.remove('hidden');
    searchIcon.classList.add('hidden');
    clearButton.classList.add('hidden');
}

function ocultarIndicadorCarga() {
    loadingIndicator.classList.add('hidden');
    searchIcon.classList.remove('hidden');

    if (searchInput.value.trim().length > 0) {
        clearButton.classList.remove('hidden');
        searchIcon.classList.add('hidden');
    }
}

function mostrarError(mensaje) {
    pacientesList.innerHTML = `
        <div class="p-4 text-center text-red-500">
            <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            ${mensaje}
        </div>
    `;
    noResults.classList.add('hidden');
    minCharsMessage.classList.add('hidden');
    mostrarDropdown();
}

// ==============================
// 5. HISTORIAL DE ATENCIONES
// ==============================

/**
 * Función para cargar las consultas dinámicamente
 * @param {Array} atenciones - Lista de atenciones del paciente
 */
function cargarConsultas(atenciones) {
    const container = document.getElementById('consultas-container');
    const noConsultasMsg = document.getElementById('no-consultas-mensaje');

    // Limpiar contenedor
    container.innerHTML = '';

    if (!atenciones || atenciones.length === 0) {
        noConsultasMsg.classList.remove('hidden');
        return;
    }

    noConsultasMsg.classList.add('hidden');

    // Renderizar cada consulta
    atenciones.forEach((atencion, index) => {
        const consultaElement = crearConsultaElement(atencion, index);
        container.appendChild(consultaElement);
    });
}

/**
 * Función para crear el elemento HTML de una consulta
 * @param {Object} atencion - Datos de la atención médica
 * @param {number} index - Índice de la consulta
 * @returns {HTMLElement} - Elemento DOM de la consulta
 */
function crearConsultaElement(atencion, index) {
    const consultaDiv = document.createElement('div');

    // Determinar color del borde según el tipo de consulta
    const colorConfig = getColorConfig(atencion.tipo_consulta);

    consultaDiv.className = `bg-white rounded-2xl shadow-xl p-8 card-hover transition-all duration-300 border-l-4 ${colorConfig.border}`;

    // Formatear fecha
    const fecha = new Date(atencion.fecha_atencion);
    const fechaFormateada = fecha.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    consultaDiv.innerHTML = `
        <div class="flex justify-between items-start mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-4 h-4 ${colorConfig.dot} rounded-full"></div>
                <h3 class="text-xl font-bold text-gray-800">${fechaFormateada}</h3>
                <span class="${colorConfig.badge} px-3 py-1 rounded-full text-sm font-medium">${atencion.tipo_consulta}</span>
            </div>
            <button class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Evaluación Clínica -->
            <div class="lg:col-span-2 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-xl">
                        <h4 class="font-semibold text-blue-800 text-sm mb-2">Motivo de Consulta</h4>
                        <p class="text-blue-700">${atencion.motivo_consulta || 'No especificado'}</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl">
                        <h4 class="font-semibold text-purple-800 text-sm mb-2">Síntomas</h4>
                        <p class="text-purple-700">${atencion.sintomas || 'No especificado'}</p>
                    </div>
                </div>

                ${atencion.examen_fisico ? `
                    <div class="bg-green-50 p-4 rounded-xl">
                        <h4 class="font-semibold text-green-800 text-sm mb-2">Examen Físico</h4>
                        <p class="text-green-700">${atencion.examen_fisico}</p>
                    </div>
                ` : ''}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-red-50 p-4 rounded-xl">
                        <h4 class="font-semibold text-red-800 text-sm mb-2">Diagnósticos</h4>
                        <p class="text-red-700">${atencion.diagnosticos && atencion.diagnosticos.length > 0 ? atencion.diagnosticos.join(', ') : 'Sin diagnósticos registrados'}</p>
                    </div>
                    <div class="bg-cyan-50 p-4 rounded-xl">
                        <h4 class="font-semibold text-cyan-800 text-sm mb-2">Plan de Tratamiento</h4>
                        <p class="text-cyan-700">${atencion.tratamiento || 'No especificado'}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${atencion.examenes_enviados ? `
                        <div class="bg-yellow-50 p-4 rounded-xl">
                            <h4 class="font-semibold text-yellow-800 text-sm mb-2">Exámenes Solicitados</h4>
                            <p class="text-yellow-700">${atencion.examenes_enviados}</p>
                        </div>
                    ` : ''}
                    ${atencion.comentario_adicional ? `
                        <div class="bg-gray-50 p-4 rounded-xl">
                            <h4 class="font-semibold text-gray-800 text-sm mb-2">Comentario Adicional</h4>
                            <p class="text-gray-700">${atencion.comentario_adicional}</p>
                        </div>
                    ` : ''}
                </div>

                <!-- Prescripciones -->
                ${crearPrescripcionesHTML(atencion.prescripciones)}
            </div>

            <!-- Signos Vitales -->
            <div class="lg:col-span-1">
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-xl">
                    <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                        <svg class="w-4 h-4 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                        Signos Vitales
                    </h4>
                    <div class="space-y-3">
                        ${crearSignosVitalesHTML(atencion)}
                    </div>
                </div>
            </div>
        </div>
    `;

    return consultaDiv;
}

/**
 * Función para obtener configuración de colores según tipo de consulta
 * @param {string} tipoConsulta - Tipo de consulta
 * @returns {Object} - Configuración de colores
 */
function getColorConfig(tipoConsulta) {
    const configs = {
        'Control': {
            border: 'border-blue-500',
            dot: 'bg-blue-500',
            badge: 'bg-blue-100 text-blue-800'
        },
        'Urgencia': {
            border: 'border-green-500',
            dot: 'bg-green-500',
            badge: 'bg-green-100 text-green-800'
        },
        'Chequeo': {
            border: 'border-purple-500',
            dot: 'bg-purple-500',
            badge: 'bg-purple-100 text-purple-800'
        }
    };

    return configs[tipoConsulta] || configs['Chequeo'];
}

/**
 * Función para crear HTML de signos vitales
 * @param {Object} atencion - Datos de la atención
 * @returns {string} - HTML de los signos vitales
 */
function crearSignosVitalesHTML(atencion) {
    const signos = [
        { label: 'Presión Arterial:', valor: atencion.presion_arterial },
        { label: 'Pulso:', valor: atencion.pulso ? `${atencion.pulso} ppm` : null },
        { label: 'Temperatura:', valor: atencion.temperatura ? `${atencion.temperatura}°C` : null },
        { label: 'Freq. Respiratoria:', valor: atencion.frecuencia_respiratoria ? `${atencion.frecuencia_respiratoria} rpm` : null },
        { label: 'Saturación O2:', valor: atencion.saturacion_oxigeno ? `${atencion.saturacion_oxigeno}%` : null },
        { label: 'Peso:', valor: atencion.peso ? `${atencion.peso} kg` : null },
        { label: 'Altura:', valor: atencion.altura ? `${atencion.altura} m` : null },
        { label: 'IMC:', valor: atencion.imc ? atencion.imc : null }
    ];

    return signos
        .filter(signo => signo.valor)
        .map(signo => `
            <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">${signo.label}</span>
                <span class="font-semibold text-gray-800">${signo.valor}</span>
            </div>
        `).join('');
}

/**
 * Función para crear HTML de prescripciones
 * @param {Array} prescripciones - Lista de prescripciones
 * @returns {string} - HTML de las prescripciones
 */
function crearPrescripcionesHTML(prescripciones) {
    if (!prescripciones || prescripciones.length === 0) {
        return '';
    }

    const prescripcionesHTML = prescripciones.map(prescripcion => `
        <div class="bg-orange-50 border-l-4 border-orange-400 p-4 rounded-r-xl">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h6 class="text-sm font-semibold text-orange-800">${prescripcion.medicamento || 'Medicamento no especificado'}</h6>
                    <p class="text-sm text-orange-700 mt-1">${prescripcion.prescripcion || 'Sin instrucciones'}</p>
                    <div class="mt-2 text-xs text-orange-600 space-x-4">
                        ${prescripcion.cantidad ? `<span>Cantidad: ${prescripcion.cantidad}</span>` : ''}
                        ${prescripcion.frecuencia_diaria ? `<span>Frecuencia: ${prescripcion.frecuencia_diaria} veces/día</span>` : ''}
                        ${prescripcion.duracion_tratamiento ? `<span>Duración: ${prescripcion.duracion_tratamiento} días</span>` : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    return `
        <div class="bg-orange-25 p-4 rounded-xl">
            <h4 class="font-semibold text-orange-800 text-sm mb-3">Prescripciones</h4>
            <div class="space-y-3">
                ${prescripcionesHTML}
            </div>
        </div>
    `;
}

/**
 * Función para integrar con el selector de pacientes
 * @param {Object} paciente - Datos del paciente
 */
function cargarConsultasPaciente(paciente) {
    if (paciente && paciente.atenciones) {
        cargarConsultas(paciente.atenciones);
    } else {
        cargarConsultas([]);
    }
}

// ==============================
// 6. MODAL PARA NUEVO PACIENTE
// ==============================

/**
 * Función para mostrar formulario de nuevo paciente
 */
function mostrarFormularioNuevoPaciente() {
    document.getElementById('modal-agregar-paciente').classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevenir scroll del body
}

/**
 * Función para cerrar modal
 */
function cerrarModalPaciente() {
    document.getElementById('modal-agregar-paciente').classList.add('hidden');
    document.body.style.overflow = 'auto'; // Restaurar scroll del body
    document.getElementById('form-nuevo-paciente').reset(); // Limpiar formulario
}

/**
 * Función para toggle del acordeón
 * @param {string} section - Sección del acordeón
 */
function toggleAccordion(section) {
    const content = document.getElementById(`content-${section}`);
    const icon = document.getElementById(`icon-${section}`);

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.remove('rotate-180');
    } else {
        content.classList.add('hidden');
        icon.classList.add('rotate-180');
    }
}

/**
 * Función de validación del formulario de paciente
 * @param {Object} data - Datos del formulario
 * @returns {boolean} - True si es válido
 */
function validarFormulario(data) {
    // Validar campos requeridos
    const camposRequeridos = ['nombres', 'apellidos', 'cedula_ecuatoriana', 'fecha_nacimiento', 'telefono', 'sexo', 'estado_civil', 'direccion'];

    for (let campo of camposRequeridos) {
        if (!data[campo] || data[campo].trim() === '') {
            alert(`❌ Error: El campo "${getCampoNombre(campo)}" es obligatorio.`);
            document.getElementById(campo).focus();
            return false;
        }
    }

    // Validar formato de cédula (10 dígitos)
    if (data.cedula_ecuatoriana && !/^\d{10}$/.test(data.cedula_ecuatoriana)) {
        alert('❌ Error: La cédula ecuatoriana debe tener exactamente 10 dígitos.');
        document.getElementById('cedula_ecuatoriana').focus();
        return false;
    }

    // Validar email si se proporciona
    if (data.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
        alert('❌ Error: Ingrese un correo electrónico válido.');
        document.getElementById('email').focus();
        return false;
    }

    // Validar fecha de nacimiento (no debe ser futura)
    if (data.fecha_nacimiento) {
        const fechaNac = new Date(data.fecha_nacimiento);
        const hoy = new Date();
        if (fechaNac > hoy) {
            alert('❌ Error: La fecha de nacimiento no puede ser futura.');
            document.getElementById('fecha_nacimiento').focus();
            return false;
        }
    }

    return true;
}

/**
 * Función auxiliar para obtener nombres legibles de campos
 * @param {string} campo - Nombre del campo
 * @returns {string} - Nombre legible
 */
function getCampoNombre(campo) {
    const nombres = {
        'nombres': 'Nombres',
        'apellidos': 'Apellidos',
        'cedula_ecuatoriana': 'Cédula Ecuatoriana',
        'fecha_nacimiento': 'Fecha de Nacimiento',
        'telefono': 'Teléfono',
        'sexo': 'Sexo',
        'estado_civil': 'Estado Civil',
        'direccion': 'Dirección'
    };
    return nombres[campo] || campo;
}

/**
 * Obtener token CSRF para Django
 * @param {string} name - Nombre de la cookie
 * @returns {string|null} - Valor de la cookie
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ==============================
// 7. FUNCIONES GLOBALES SEGURAS
// ==============================

/**
 * Función para inicializar de forma segura
 * @returns {boolean} - True si se inicializó correctamente
 */
function inicializarAtencion() {
    try {
        console.log('🔄 Intentando inicializar el sistema...');
        atencionMedica = new GestorAtencionMedica();
        console.log('✅ Sistema de atención médica inicializado correctamente');
        console.log('📋 Instancia creada:', atencionMedica);
        return true;
    } catch (error) {
        console.error('❌ Error al inicializar:', error);
        alert('Error al inicializar el sistema: ' + error.message);
        return false;
    }
}

/**
 * Función global para agregar medicamento
 */
function agregarMedicamento() {
    console.log('🔄 Función agregarMedicamento() llamada');

    if (!atencionMedica) {
        console.log('⚠️ Sistema no inicializado, intentando inicializar...');
        if (!inicializarAtencion()) {
            return;
        }
    }

    try {
        atencionMedica.agregarMedicamento();
    } catch (error) {
        console.error('❌ Error en agregarMedicamento:', error);
        alert('Error al agregar medicamento: ' + error.message);
    }
}

/**
 * Función global para eliminar medicamento de forma segura
 * @param {number} index - Índice del medicamento a eliminar
 */
function eliminarMedicamentoSeguro(index) {
    if (atencionMedica) {
        atencionMedica.eliminarMedicamento(index);
    } else {
        console.error('❌ Sistema no inicializado');
    }
}

/**
 * Función global para grabar atención
 */
function grabarAtencion() {
    console.log('🔄 Función grabarAtencion() llamada');

    if (!atencionMedica) {
        console.log('⚠️ Sistema no inicializado, intentando inicializar...');
        if (!inicializarAtencion()) {
            return;
        }
    }

    try {
        atencionMedica.grabarAtencion();
    } catch (error) {
        console.error('❌ Error en grabarAtencion:', error);
        alert('Error al grabar atención: ' + error.message);
    }
}

/**
 * Función global para agregar diagnóstico
 */
function agregarDiagnostico() {
    console.log('🔄 Función agregarDiagnostico() llamada');

    if (!atencionMedica) {
        console.log('⚠️ Sistema no inicializado, intentando inicializar...');
        if (!inicializarAtencion()) {
            return;
        }
    }

    try {
        atencionMedica.agregarDiagnostico();
    } catch (error) {
        console.error('❌ Error en agregarDiagnostico:', error);
        alert('Error al agregar diagnóstico: ' + error.message);
    }
}

/**
 * Función global para ver datos
 */
function verDatos() {
    if (!atencionMedica) {
        console.log('⚠️ Sistema no inicializado, intentando inicializar...');
        if (!inicializarAtencion()) {
            return;
        }
    }

    atencionMedica.verDatos();
}

/**
 * Función para verificar el estado del sistema
 * @returns {boolean} - Estado del sistema
 */
function verificarSistema() {
    console.log('🔍 Estado del sistema:');
    console.log('   atencionMedica:', atencionMedica);
    console.log('   Tipo:', typeof atencionMedica);
    console.log('   DOM ready:', document.readyState);
    return atencionMedica !== null;
}

// ==============================
// 8. INICIALIZACIÓN Y EVENTOS CONSOLIDADOS
// ==============================

/**
 * Función principal de inicialización cuando el DOM está listo
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 DOM cargado, inicializando sistema completo...');

    // ============================================
    // 8.1 INICIALIZAR SISTEMA DE ATENCIÓN MÉDICA
    // ============================================
    inicializarAtencion();

    // ============================================
    // 8.2 INICIALIZAR SELECTOR DE PACIENTES
    // ============================================
    // Obtener elementos DOM
    searchInput = document.getElementById('paciente-search-input');
    dropdown = document.getElementById('pacientes-dropdown');
    pacientesList = document.getElementById('pacientes-list');
    loadingIndicator = document.getElementById('loading-indicator');
    searchIcon = document.getElementById('search-icon');
    clearButton = document.getElementById('clear-button');
    noResults = document.getElementById('no-results');
    minCharsMessage = document.getElementById('min-chars-message');
    datosContainer = document.getElementById('datos-paciente-container');
    noMensaje = document.getElementById('no-paciente-mensaje');

    // Configurar Event Listeners para selector de pacientes
    if (searchInput) {
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('focus', handleInputFocus);
        searchInput.addEventListener('blur', handleInputBlur);
    }

    document.addEventListener('click', handleDocumentClick);
     // ============================================
    // 8.2.1 CARGAR PACIENTE EN MODO EDICIÓN
    // ============================================
    // Si estamos editando una atención, cargar el paciente automáticamente
    if (typeof pacienteDesdeServidor !== 'undefined' && pacienteDesdeServidor !== null) {
        console.log('🔄 Cargando paciente para edición:', pacienteDesdeServidor.nombres, pacienteDesdeServidor.apellidos);
        seleccionarPaciente(pacienteDesdeServidor);
    }
    // Fin de cargar paciente en modo edicion


    // ============================================
    // 8.3 INICIALIZAR MODAL DE NUEVO PACIENTE
    // ============================================
    const formNuevoPaciente = document.getElementById('form-nuevo-paciente');
    if (formNuevoPaciente) {
        formNuevoPaciente.addEventListener('submit', function(e) {
            e.preventDefault();

            // Obtener datos del formulario
            const formData = new FormData(this);
            const pacienteData = {};

            // Convertir FormData a objeto
            for (let [key, value] of formData.entries()) {
                pacienteData[key] = value;
            }

            // Validaciones básicas
            if (!validarFormulario(pacienteData)) {
                return;
            }

            // Aquí iría la lógica para enviar al backend
            console.log('Datos del nuevo paciente:', pacienteData);

            // Simulación de guardado exitoso
            alert('✅ Paciente agregado exitosamente!\n\nNombre: ' + pacienteData.nombres + ' ' + pacienteData.apellidos + '\nCédula: ' + pacienteData.cedula_ecuatoriana);

            // Cerrar modal y limpiar formulario
            cerrarModalPaciente();
        });
    }

    // ============================================
    // 8.4 CONFIGURAR EVENTOS ADICIONALES
    // ============================================

    // Cerrar modal al hacer clic fuera de él
    const modalAgregarPaciente = document.getElementById('modal-agregar-paciente');
    if (modalAgregarPaciente) {
        modalAgregarPaciente.addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalPaciente();
            }
        });
    }

    // Formatear cédula mientras se escribe (solo números)
    const cedulaInput = document.getElementById('cedula_ecuatoriana');
    if (cedulaInput) {
        cedulaInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });
    }

    // Mostrar/ocultar campo gineco-obstétrico según el sexo
    const sexoSelect = document.getElementById('sexo');
    if (sexoSelect) {
        sexoSelect.addEventListener('change', function() {
            const ginecoField = document.getElementById('antecedentes_gineco_obstetricos');
            if (ginecoField) {
                const ginecoContainer = ginecoField.closest('div');
                if (this.value === 'FEMENINO') {
                    ginecoContainer.style.display = 'block';
                } else {
                    ginecoContainer.style.display = 'none';
                    ginecoField.value = '';
                }
            }
        });
    }

    // JavaScript para manejar el checkbox de consulta de control
    const consultaControlCheckbox = document.getElementById('consulta-control');
    if (consultaControlCheckbox) {
        consultaControlCheckbox.addEventListener('change', function() {
            const label = this.nextElementSibling.nextElementSibling;
            if (this.checked) {
                label.textContent = '✓ Sí, es consulta de control';
                label.classList.remove('text-teal-700');
                label.classList.add('text-teal-800', 'font-semibold');
            } else {
                label.textContent = '¿Es consulta de control?';
                label.classList.remove('text-teal-800', 'font-semibold');
                label.classList.add('text-teal-700');
            }
        });
    }

    // ============================================
    // 8.5 ANIMACIONES SUAVES AL CARGAR
    // ============================================
    const cards = document.querySelectorAll('.card-hover');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });

    console.log('✅ Sistema completo inicializado correctamente');
});

// ============================================
// 8.6 EVENTOS ADICIONALES DE RESPALDO
// ============================================

// Cerrar modal con tecla Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('modal-agregar-paciente');
        if (modal && !modal.classList.contains('hidden')) {
            cerrarModalPaciente();
        }
    }
});

// Inicialización de respaldo cuando la ventana termine de cargar
window.addEventListener('load', function() {
    console.log('🪟 Ventana cargada');
    if (!atencionMedica) {
        console.log('🔄 Inicialización de respaldo...');
        inicializarAtencion();
    }
});

// Inicialización por timeout como último recurso
setTimeout(function() {
    if (!atencionMedica && document.readyState === 'complete') {
        console.log('⏰ Inicialización por timeout...');
        inicializarAtencion();
    }
}, 500);

// ==============================
// 9. EXPOSICIÓN DE FUNCIONES GLOBALES
// ==============================

// ==============================
// 11. FUNCIONES GLOBALES PARA SERVICIOS
// ==============================

/**
 * Función global para agregar formulario de servicio
 */
function agregarFormularioServicio() {
    console.log('🔄 Función agregarFormularioServicio() llamada');

    if (!atencionMedica) {
        console.log('⚠️ Sistema no inicializado, intentando inicializar...');
        if (!inicializarAtencion()) {
            return;
        }
    }

    try {
        atencionMedica.agregarFormularioServicio();
    } catch (error) {
        console.error('❌ Error en agregarFormularioServicio:', error);
        alert('Error al agregar formulario de servicio: ' + error.message);
    }
}

// Hacer funciones disponibles globalmente para el HTML
window.verificarSistema = verificarSistema;
window.inicializarAtencion = inicializarAtencion;
window.agregarMedicamento = agregarMedicamento;
window.eliminarMedicamentoSeguro = eliminarMedicamentoSeguro;
window.grabarAtencion = grabarAtencion;
window.agregarDiagnostico = agregarDiagnostico;
window.verDatos = verDatos;
window.showTab = showTab;
window.mostrarFormularioNuevoPaciente = mostrarFormularioNuevoPaciente;
window.cerrarModalPaciente = cerrarModalPaciente;
window.toggleAccordion = toggleAccordion;
window.limpiarSeleccion = limpiarSeleccion;
window.agregarFormularioServicio = agregarFormularioServicio;

console.log('📜 Sistema de Atención Médica - Código organizado cargado y esperando inicialización...');

// ==============================
// 10. FUNCIONALIDAD DE DICTADO POR VOZ
// ==============================

/**
 * Función para iniciar dictado por voz
 * @param {string} textareaId - ID del textarea donde se insertará el texto
 */
function iniciarDictado(event, textareaId) {
    const textarea = document.getElementById(textareaId);
    const button = event.target.closest('button');
    const buttonText = button.querySelector('span');
    
    if (!textarea) {
        console.error('Textarea no encontrado:', textareaId);
        return;
    }

    // Verificar si estamos en un contexto seguro
    const isSecureContext = window.isSecureContext || 
                          location.protocol === 'https:' || 
                          location.hostname === 'localhost' || 
                          location.hostname === '127.0.0.1';
    
    // Verificar específicamente si estamos en localhost con Django
    const isDjangoLocalhost = (location.hostname === '127.0.0.1' || location.hostname === 'localhost') && 
                             (location.port === '8000' || location.port === '');
    
    if (!isSecureContext && !isDjangoLocalhost) {
        alert('⚠️ El dictado por voz requiere una conexión segura\n\n' +
              'Para usar esta función:\n' +
              '1. Usa el servidor de desarrollo de Django (python manage.py runserver)\n' +
              '2. O configura HTTPS en el servidor de producción\n' +
              '3. Asegúrate de estar en localhost o 127.0.0.1');
        return;
    }

    // Verificar soporte del navegador
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('❌ Tu navegador no soporta reconocimiento de voz.\n\nNavegadores compatibles:\n• Chrome\n• Edge\n• Safari (versiones recientes)');
        return;
    }

    // Si ya está grabando, detener
    if (window.currentRecognition) {
        window.currentRecognition.stop();
        return;
    }

    // Crear nueva instancia de reconocimiento (compatibilidad con diferentes navegadores)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    window.currentRecognition = recognition;

    // Configuración
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'es-ES';
    recognition.maxAlternatives = 1;

    // Eventos
    recognition.onstart = function() {
        console.log('🎤 Dictado iniciado');
        buttonText.textContent = 'Detener Dictado';
        button.classList.remove('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
        button.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
        
        // Crear indicador de estado si no existe
        let statusDiv = document.getElementById('voice-status-' + textareaId);
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'voice-status-' + textareaId;
            statusDiv.className = 'mt-2 text-sm text-emerald-600 flex items-center';
            statusDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i><span>🎤 Escuchando... Habla ahora</span>';
            textarea.parentNode.appendChild(statusDiv);
        }
        statusDiv.style.display = 'flex';
    };

    recognition.onend = function() {
        console.log('🎤 Dictado finalizado');
        buttonText.textContent = 'Dictar';
        button.classList.remove('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
        button.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
        
        const statusDiv = document.getElementById('voice-status-' + textareaId);
        if (statusDiv) {
            statusDiv.style.display = 'none';
        }
        
        window.currentRecognition = null;
    };

    recognition.onresult = function(event) {
        let finalTranscript = '';
        let interimTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript + '. ';
            } else {
                interimTranscript += transcript;
            }
        }
        
        if (finalTranscript) {
            // Agregar el texto al final del contenido existente
            const currentValue = textarea.value;
            const newValue = currentValue ? currentValue + ' ' + finalTranscript : finalTranscript;
            textarea.value = newValue.trim();
            
            // Disparar evento de cambio para que otros scripts detecten el cambio
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            
            console.log('✅ Texto agregado:', finalTranscript);
        }
        
        // Mostrar texto temporal en el indicador de estado
        if (interimTranscript) {
            const statusDiv = document.getElementById('voice-status-' + textareaId);
            if (statusDiv) {
                statusDiv.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-2"></i><span>🎤 "${interimTranscript}"</span>`;
            }
        }
    };

    recognition.onerror = function(event) {
        console.error('❌ Error en reconocimiento de voz:', event.error);
        
        let errorMessage = '';
        let solution = '';
        
        switch(event.error) {
            case 'network':
                errorMessage = 'Error de conexión de red';
                solution = 'Verifica tu conexión a internet y que estés usando HTTPS o localhost.';
                break;
            case 'no-speech':
                errorMessage = 'No se detectó voz';
                solution = 'Intenta hablar más cerca del micrófono y más claramente.';
                break;
            case 'audio-capture':
                errorMessage = 'No se pudo acceder al micrófono';
                solution = 'Verifica que tu micrófono esté conectado y funcionando.';
                break;
            case 'not-allowed':
                errorMessage = 'Permiso de micrófono denegado';
                solution = 'Permite el acceso al micrófono en la configuración del navegador.';
                break;
            case 'service-not-allowed':
                errorMessage = 'Servicio de reconocimiento no permitido';
                solution = 'Usa HTTPS o localhost para acceder a esta función.';
                break;
            case 'bad-grammar':
                errorMessage = 'Error de gramática en el reconocimiento';
                solution = 'Intenta hablar más claramente.';
                break;
            case 'language-not-supported':
                errorMessage = 'Idioma no soportado';
                solution = 'El español puede no estar disponible en tu navegador.';
                break;
            default:
                errorMessage = 'Error desconocido en el reconocimiento de voz';
                solution = 'Intenta recargar la página y usar Chrome o Edge.';
        }
        
        alert(`❌ ${errorMessage}\n\n💡 Solución: ${solution}\n\n🔧 Error técnico: ${event.error}`);
        
        // Resetear el botón
        buttonText.textContent = 'Dictar';
        button.classList.remove('bg-red-100', 'text-red-800');
        button.classList.add('bg-blue-100', 'text-blue-800');
        
        const statusDiv = document.getElementById('voice-status-' + textareaId);
        if (statusDiv) {
            statusDiv.style.display = 'none';
        }
        
        window.currentRecognition = null;
    };

    // Iniciar reconocimiento
    try {
        console.log('🚀 Iniciando reconocimiento de voz...');
        recognition.start();
    } catch (error) {
        console.error('❌ Error al iniciar reconocimiento:', error);
        alert(`❌ Error al iniciar el reconocimiento de voz\n\n🔧 Detalles: ${error.message}\n\n💡 Asegúrate de usar HTTPS o localhost`);
    }
}

// Hacer la función disponible globalmente
window.iniciarDictado = iniciarDictado;

// ==============================
// 11. LÓGICA DE PAGO CON PAYPAL
// ==============================
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si estamos en modo edición y hay un contenedor de PayPal
    if (modoEdicion && document.getElementById('paypal-button-container')) {
        // Verificar si PayPal está disponible
        if (typeof paypal === 'undefined') {
            console.warn('PayPal SDK no está cargado. Verifique la configuración de PAYPAL_CLIENT_ID.');
            const container = document.getElementById('paypal-button-container');
            if (container) {
                container.innerHTML = '<div class="text-yellow-600 text-center p-4">PayPal no está configurado. Contacte al administrador.</div>';
            }
            return;
        }

        const atencionId = {{ atencion.id|default:"null" }};
        const pagoId = {{ pago.id|default:"null" }};
        const montoTotal = parseFloat("{{ pago.monto_total|default:'0.00' }}");

        if (atencionId && pagoId && montoTotal > 0) {
            paypal.Buttons({
                createOrder: function(data, actions) {
                    console.log('Creating PayPal order...');
                    return fetch('/doctor/create-paypal-order/', {
                        method: 'post',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ 'atencion_id': atencionId })
                    }).then(function(res) {
                        return res.json();
                    }).then(function(orderData) {
                        console.log('Order created:', orderData);
                        return orderData.paypal_order_id;
                    });
                },
                onApprove: function(data, actions) {
                    console.log('Payment approved:', data);
                    return fetch('/doctor/capture-paypal-payment/', {
                        method: 'post',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            'paypal_order_id': data.orderID,
                            'payer_id': data.payerID,
                            'atencion_id': atencionId
                        })
                    }).then(function(res) {
                        return res.json();
                    }).then(function(paymentData) {
                        console.log('Payment captured:', paymentData);
                        const messagesDiv = document.getElementById('paypal-messages');
                        if (paymentData.status === 'success') {
                            messagesDiv.innerHTML = '<div class="text-green-600">' + paymentData.message + '</div>';
                            document.getElementById('pago-estado').textContent = 'Pagado';
                            document.getElementById('pago-estado').className = 'px-3 py-1 rounded-full text-sm font-semibold bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
                            document.getElementById('paypal-button-container').style.display = 'none';
                        } else {
                            messagesDiv.innerHTML = '<div class="text-red-600">Error: ' + paymentData.message + '</div>';
                        }
                    });
                },
                onError: function(err) {
                    console.error('PayPal Error:', err);
                    document.getElementById('paypal-messages').innerHTML = '<div class="text-red-600">Ocurrió un error con PayPal. Por favor, intente de nuevo.</div>';
                }
            }).render('#paypal-button-container');
        }
    }
});
</script>

{% endblock content %}  