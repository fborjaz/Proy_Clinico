{% extends 'home.html' %}
<title>{% block title %}{{ grabar }}{% endblock %}</title>
{% block content %}
    {% load static %}
    {% include 'components/messages.html' %}
    <section class="dark:bg-principal mt-2">
        <div class="text-center" data-aos="fade-up" data-aos-delay="200">
            <div class="sm:pt-8 lg:pt-4">
                <h1 class="rounded-2xl bg-emerald-600 px-2 py-1 text-blue-800 uppercase text-4xl">
                    {{ grabar }}
                </h1>
            </div>

            <div class="lg:p-2 rounded-3xl" data-aos="fade-up" data-aos-delay="200">
                <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                    <form method="post" id="citaForm">
                        {% csrf_token %}
                        
                        <!-- Patient Selection -->
                        <div class="mb-6">
                            <label for="{{ form.paciente.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-user text-blue-500 mr-1"></i>
                                {{ form.paciente.label }}
                            </label>
                            <div class="relative">
                                <input type="text" id="pacienteSearch" 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Buscar paciente por nombre, apellido o c√©dula..."
                                    value="{% if form.paciente.value %}{{ form.paciente.value }}{% endif %}">
                                <div id="pacienteResults" class="absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 hidden max-h-60 overflow-y-auto"></div>
                            </div>
                            {{ form.paciente.as_hidden }}
                            {% if form.paciente.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.paciente.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Date -->
                            <div>
                                <label for="{{ form.fecha.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-calendar text-emerald-500 mr-1"></i>
                                    {{ form.fecha.label }}
                                </label>
                                {{ form.fecha }}
                                {% if form.fecha.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.fecha.errors }}</div>
                                {% endif %}
                            </div>

                            <!-- Time -->
                            <div>
                                <label for="{{ form.hora_cita.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-clock text-blue-500 mr-1"></i>
                                    {{ form.hora_cita.label }}
                                </label>
                                {{ form.hora_cita }}
                                {% if form.hora_cita.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.hora_cita.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Status -->
                        <div class="mt-6">
                            <label for="{{ form.estado.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-info-circle text-yellow-500 mr-1"></i>
                                {{ form.estado.label }}
                            </label>
                            {{ form.estado }}
                            {% if form.estado.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.estado.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Observations with Voice Input -->
                        <div class="mt-6">
                            <div class="flex justify-between items-center mb-2">
                                <label for="{{ form.observaciones.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    <i class="fas fa-notes-medical text-purple-500 mr-1"></i>
                                    {{ form.observaciones.label }}
                                </label>
                                <button type="button" 
                                        onclick="iniciarDictado(event, '{{ form.observaciones.id_for_label }}')" 
                                        class="flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-200 dark:hover:bg-blue-800 transition-colors">
                                    <i class="fas fa-microphone mr-1"></i>
                                    <span>Dictar</span>
                                </button>
                            </div>
                            {{ form.observaciones }}
                            {% if form.observaciones.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.observaciones.errors }}</div>
                            {% endif %}
                            </div>

                        <script>
                        // Tu funci√≥n iniciarDictado completa, tal cual la tienes:
                        // ==============================
                        // 10. FUNCIONALIDAD DE DICTADO POR VOZ
                        // ==============================

                        /**
                        * Funci√≥n para iniciar dictado por voz
                        * @param {Event} event - El evento del click del bot√≥n
                        * @param {string} textareaId - ID del textarea donde se insertar√° el texto
                        */
                        function iniciarDictado(event, textareaId) {
                            const textarea = document.getElementById(textareaId);
                            const button = event.target.closest('button');
                            const buttonText = button.querySelector('span');
                            
                            if (!textarea) {
                                console.error('Textarea no encontrado:', textareaId);
                                return;
                            }

                            // Verificar si estamos en un contexto seguro
                            const isSecureContext = window.isSecureContext || 
                                                    location.protocol === 'https:' || 
                                                    location.hostname === 'localhost' || 
                                                    location.hostname === '127.0.0.1';
                            
                            // Verificar espec√≠ficamente si estamos en localhost con Django
                            const isDjangoLocalhost = (location.hostname === '127.0.0.1' || location.hostname === 'localhost') && 
                                                    (location.port === '8000' || location.port === '');
                            
                            if (!isSecureContext && !isDjangoLocalhost) {
                                alert('‚ö†Ô∏è El dictado por voz requiere una conexi√≥n segura\n\n' +
                                    'Para usar esta funci√≥n:\n' +
                                    '1. Usa el servidor de desarrollo de Django (python manage.py runserver)\n' +
                                    '2. O configura HTTPS en el servidor de producci√≥n\n' +
                                    '3. Aseg√∫rate de estar en localhost o 127.0.0.1');
                                return;
                            }

                            // Verificar soporte del navegador
                            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                                alert('‚ùå Tu navegador no soporta reconocimiento de voz.\n\nNavegadores compatibles:\n‚Ä¢ Chrome\n‚Ä¢ Edge\n‚Ä¢ Safari (versiones recientes)');
                                return;
                            }

                            // Si ya est√° grabando, detener
                            if (window.currentRecognition) {
                                window.currentRecognition.stop();
                                return;
                            }

                            // Crear nueva instancia de reconocimiento (compatibilidad con diferentes navegadores)
                            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                            const recognition = new SpeechRecognition();
                            window.currentRecognition = recognition;

                            // Configuraci√≥n
                            recognition.continuous = true;
                            recognition.interimResults = true;
                            recognition.lang = 'es-ES';
                            recognition.maxAlternatives = 1;

                            // Eventos
                            recognition.onstart = function() {
                                console.log('üé§ Dictado iniciado');
                                buttonText.textContent = 'Detener Dictado';
                                button.classList.remove('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
                                button.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                                
                                // Crear indicador de estado si no existe
                                let statusDiv = document.getElementById('voice-status-' + textareaId);
                                if (!statusDiv) {
                                    statusDiv = document.createElement('div');
                                    statusDiv.id = 'voice-status-' + textareaId;
                                    statusDiv.className = 'mt-2 text-sm text-emerald-600 flex items-center';
                                    statusDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i><span>üé§ Escuchando... Habla ahora</span>';
                                    textarea.parentNode.appendChild(statusDiv);
                                }
                                statusDiv.style.display = 'flex';
                            };

                            recognition.onend = function() {
                                console.log('üé§ Dictado finalizado');
                                buttonText.textContent = 'Dictar';
                                button.classList.remove('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                                button.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
                                
                                const statusDiv = document.getElementById('voice-status-' + textareaId);
                                if (statusDiv) {
                                    statusDiv.style.display = 'none';
                                    // Tambi√©n oculta el texto intermedio si estaba visible
                                    const interimTextSpan = statusDiv.querySelector('span');
                                    if (interimTextSpan) interimTextSpan.textContent = '';
                                }
                                
                                window.currentRecognition = null;
                            };

                            recognition.onresult = function(event) {
                                let finalTranscript = '';
                                let interimTranscript = '';
                                
                                for (let i = event.resultIndex; i < event.results.length; i++) {
                                    const transcript = event.results[i][0].transcript;
                                    if (event.results[i].isFinal) {
                                        finalTranscript += transcript + '. ';
                                    } else {
                                        interimTranscript += transcript;
                                    }
                                }
                                
                                if (finalTranscript) {
                                    // Agregar el texto al final del contenido existente
                                    const currentValue = textarea.value;
                                    const newValue = currentValue ? currentValue + ' ' + finalTranscript : finalTranscript;
                                    textarea.value = newValue.trim();
                                    
                                    // Disparar evento de cambio para que otros scripts detecten el cambio
                                    textarea.dispatchEvent(new Event('input', { bubbles: true }));
                                    
                                    console.log('‚úÖ Texto agregado:', finalTranscript);
                                }
                                
                                // Mostrar texto temporal en el indicador de estado
                                if (interimTranscript) {
                                    const statusDiv = document.getElementById('voice-status-' + textareaId);
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-2"></i><span>üé§ "${interimTranscript}"</span>`;
                                    }
                                }
                            };

                            recognition.onerror = function(event) {
                                console.error('‚ùå Error en reconocimiento de voz:', event.error);
                                
                                let errorMessage = '';
                                let solution = '';
                                
                                switch(event.error) {
                                    case 'network':
                                        errorMessage = 'Error de conexi√≥n de red';
                                        solution = 'Verifica tu conexi√≥n a internet y que est√©s usando HTTPS o localhost.';
                                        break;
                                    case 'no-speech':
                                        errorMessage = 'No se detect√≥ voz';
                                        solution = 'Intenta hablar m√°s cerca del micr√≥fono y m√°s claramente.';
                                        break;
                                    case 'audio-capture':
                                        errorMessage = 'No se pudo acceder al micr√≥fono';
                                        solution = 'Verifica que tu micr√≥fono est√© conectado y funcionando.';
                                        break;
                                    case 'not-allowed':
                                        errorMessage = 'Permiso de micr√≥fono denegado';
                                        solution = 'Permite el acceso al micr√≥fono en la configuraci√≥n del navegador.';
                                        break;
                                    case 'service-not-allowed':
                                        errorMessage = 'Servicio de reconocimiento no permitido';
                                        solution = 'Usa HTTPS o localhost para acceder a esta funci√≥n.';
                                        break;
                                    case 'bad-grammar':
                                        errorMessage = 'Error de gram√°tica en el reconocimiento';
                                        solution = 'Intenta hablar m√°s claramente.';
                                        break;
                                    case 'language-not-supported':
                                        errorMessage = 'Idioma no soportado';
                                        solution = 'El espa√±ol puede no estar disponible en tu navegador.';
                                        break;
                                    default:
                                        errorMessage = 'Error desconocido en el reconocimiento de voz';
                                        solution = 'Intenta recargar la p√°gina y usar Chrome o Edge.';
                                }
                                
                                alert(`‚ùå ${errorMessage}\n\nüí° Soluci√≥n: ${solution}\n\nüîß Error t√©cnico: ${event.error}`);
                                
                                // Resetear el bot√≥n
                                buttonText.textContent = 'Dictar';
                                button.classList.remove('bg-red-100', 'text-red-800');
                                button.classList.add('bg-blue-100', 'text-blue-800');
                                
                                const statusDiv = document.getElementById('voice-status-' + textareaId);
                                if (statusDiv) {
                                    statusDiv.style.display = 'none';
                                }
                                
                                window.currentRecognition = null;
                            };

                            // Iniciar reconocimiento
                            try {
                                console.log('üöÄ Iniciando reconocimiento de voz...');
                                recognition.start();
                            } catch (error) {
                                console.error('‚ùå Error al iniciar reconocimiento:', error);
                                alert(`‚ùå Error al iniciar el reconocimiento de voz\n\nüîß Detalles: ${error.message}\n\nüí° Aseg√∫rate de usar HTTPS o localhost`);
                            }
                        }

                        // Hacer la funci√≥n disponible globalmente
                        window.iniciarDictado = iniciarDictado;
                    </script>

                        <!-- Available Time Slots (for date selection) -->
                        <div id="availableSlots" class="mt-6 hidden">
                            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">
                                <i class="fas fa-clock text-emerald-500 mr-2"></i>
                                Horarios Disponibles
                            </h3>
                            <div id="slotsContainer" class="grid grid-cols-3 md:grid-cols-6 gap-2">
                                <!-- Time slots will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200 dark:border-gray-600">
                            <a href="{{ back_url }}" 
                                class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg transition-colors duration-200 flex items-center">
                                <i class="fas fa-arrow-left mr-2"></i>
                                Cancelar
                            </a>
                            
                            <button type="submit" 
                                class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-6 rounded-lg transition-colors duration-200 flex items-center">
                                <i class="fas fa-save mr-2"></i>
                                {{ grabar }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize form fields with proper classes
            const formFields = document.querySelectorAll('input, select, textarea');
            formFields.forEach(field => {
                if (!field.classList.contains('hidden')) {
                    field.classList.add('w-full', 'p-3', 'border', 'border-gray-300', 'rounded-lg', 
                        'focus:ring-2', 'focus:ring-emerald-500', 'focus:border-transparent',
                        'dark:bg-gray-700', 'dark:border-gray-600', 'dark:text-white');
                }
            });

            // Patient search functionality
            const pacienteSearch = document.getElementById('pacienteSearch');
            const pacienteResults = document.getElementById('pacienteResults');
            const pacienteInput = document.getElementById('{{ form.paciente.id_for_label }}');
            
            let searchTimeout;
            
            pacienteSearch.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 3) {
                    pacienteResults.classList.add('hidden');
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    fetch(`/core/paciente_find/?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            pacienteResults.innerHTML = '';
                            
                            if (data.success && data.pacientes && data.pacientes.length > 0) {
                                data.pacientes.forEach(paciente => {
                                    const div = document.createElement('div');
                                    div.className = 'p-3 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer border-b border-gray-200 dark:border-gray-600';
                                    
                                    // Construir n√∫mero de identificaci√≥n
                                    let identificacion = paciente.cedula_ecuatoriana || paciente.dni || 'Sin identificaci√≥n';
                                    
                                    div.innerHTML = `
                                        <div class="font-medium text-gray-900 dark:text-gray-100">
                                            ${paciente.nombres} ${paciente.apellidos}
                                        </div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">
                                            ${identificacion} - ${paciente.telefono || 'Sin tel√©fono'}
                                        </div>
                                    `;
                                    div.addEventListener('click', () => {
                                        pacienteSearch.value = `${paciente.nombres} ${paciente.apellidos}`;
                                        pacienteInput.value = paciente.id;
                                        pacienteResults.classList.add('hidden');
                                    });
                                    pacienteResults.appendChild(div);
                                });
                                pacienteResults.classList.remove('hidden');
                            } else {
                                const message = data.message || 'No se encontraron pacientes';
                                pacienteResults.innerHTML = `<div class="p-3 text-gray-500 dark:text-gray-400">${message}</div>`;
                                pacienteResults.classList.remove('hidden');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            pacienteResults.innerHTML = '<div class="p-3 text-red-500 dark:text-red-400">Error al buscar pacientes</div>';
                            pacienteResults.classList.remove('hidden');
                        });
                }, 300);
            });

            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!pacienteSearch.contains(e.target) && !pacienteResults.contains(e.target)) {
                    pacienteResults.classList.add('hidden');
                }
            });

            // Date change handler to show available slots
            const fechaInput = document.getElementById('{{ form.fecha.id_for_label }}');
            const horaInput = document.getElementById('{{ form.hora_cita.id_for_label }}');
            const availableSlots = document.getElementById('availableSlots');
            const slotsContainer = document.getElementById('slotsContainer');

            fechaInput.addEventListener('change', function() {
                const fecha = this.value;
                if (fecha) {
                    fetch(`{% url 'doctor:api_horarios_disponibles' %}?fecha=${fecha}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                slotsContainer.innerHTML = '';
                                data.horarios.forEach(slot => {
                                    const button = document.createElement('button');
                                    button.type = 'button';
                                    button.className = `p-3 rounded-lg text-center text-base font-medium transition-all duration-200 ${
                                        slot.disponible
                                            ? 'bg-emerald-100 text-emerald-800 hover:bg-emerald-200 dark:bg-emerald-900 dark:text-emerald-200 cursor-pointer hover:shadow-md'
                                            : 'bg-gray-100 text-gray-400 cursor-not-allowed dark:bg-gray-700'
                                    }`;
                                    
                                    // Agregar efecto hover solo para slots disponibles
                                    if (slot.disponible) {
                                        button.addEventListener('mouseenter', function() {
                                            this.style.transform = 'translateY(-2px)';
                                        });
                                        
                                        button.addEventListener('mouseleave', function() {
                                            this.style.transform = 'translateY(0)';
                                        });
                                    }
                                    button.disabled = !slot.disponible;
                                    button.textContent = slot.hora;
                                    
                                    if (slot.disponible) {
                                        button.addEventListener('click', () => {
                                            horaInput.value = slot.hora;
                                            // Update visual selection
                                            slotsContainer.querySelectorAll('button').forEach(b => {
                                                b.classList.remove('ring-2', 'ring-emerald-500');
                                            });
                                            button.classList.add('ring-2', 'ring-emerald-500');
                                        });
                                    }
                                    
                                    slotsContainer.appendChild(button);
                                });
                                availableSlots.classList.remove('hidden');
                            }
                        })
                        .catch(error => console.error('Error:', error));
                } else {
                    availableSlots.classList.add('hidden');
                }
            });

            // Pre-populate from URL parameters (from calendar)
            const urlParams = new URLSearchParams(window.location.search);
            const fechaParam = urlParams.get('fecha');
            const horaParam = urlParams.get('hora');
            
            if (fechaParam) {
                fechaInput.value = fechaParam;
                fechaInput.dispatchEvent(new Event('change'));
            }
            
            if (horaParam) {
                horaInput.value = horaParam;
            }

            // Form submission
            document.getElementById('citaForm').addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';
                submitBtn.disabled = true;
            });
        });
    </script>
{% endblock %}
