{% extends 'base.html' %}

{% block title %}
    {% if object %}
        Editar Empleado
    {% else %}
        Nuevo Empleado
    {% endif %} - SaludTotal
{% endblock %}

{% block content %}
    {% load static %}

    <!-- Contenedor principal con altura controlada -->
    <div class="min-h-screen bg-gray-50 dark:bg-gray-900 relative">
        <!-- Medical pattern background -->
        <div class="absolute inset-0 opacity-5 dark:opacity-10 pointer-events-none">
            <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <pattern id="medical-cross-form" x="0" y="0" width="60" height="60" patternUnits="userSpaceOnUse">
                        <path d="M25 15h10v10h10v10h-10v10h-10v-10h-10v-10h10z" fill="currentColor" opacity="0.1"/>
                    </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#medical-cross-form)" class="text-blue-500"/>
            </svg>
        </div>

        <div class="relative z-10 w-full px-6 py-8">
            <!-- Header con dise√±o m√©dico profesional -->
            <div class="bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-blue-700 dark:to-cyan-700 text-white p-8 rounded-2xl shadow-2xl mb-8 border border-blue-200 dark:border-blue-600 overflow-hidden">
                <!-- Medical pattern overlay -->
                <div class="absolute inset-0 opacity-10">
                    <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <pattern id="medical-cross-header-form" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                                <path d="M15 10h10v5h5v10h-5v5h-10v-5h-5v-10h5z" fill="currentColor" opacity="0.1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#medical-cross-header-form)" class="text-white"/>
                    </svg>
                </div>
                <div class="relative z-10 flex flex-col sm:flex-row items-start sm:items-center justify-between">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center shadow-lg border-2 border-white/30 backdrop-blur-sm">
                            <i class="fas fa-{% if object %}edit{% else %}user-plus{% endif %} text-2xl text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl sm:text-3xl font-bold flex items-center">
                                <i class="fas fa-briefcase mr-3"></i>
                                {% if object %}
                                    Editar Empleado
                                {% else %}
                                    Nuevo Empleado
                                {% endif %}
                            </h1>
                            <p class="text-blue-100 mt-1 text-sm sm:text-base flex items-center">
                                <i class="fas fa-users mr-2"></i>
                                {% if object %}
                                    Modifica la informaci√≥n del empleado "{{ object.nombre_completo }}"
                                {% else %}
                                    Registra un nuevo empleado en el sistema
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="text-right mt-4 sm:mt-0">
                        <div class="w-20 h-20 bg-white/20 rounded-2xl flex flex-col items-center justify-center shadow-lg border-2 border-white/30 backdrop-blur-sm">
                            <div class="text-xl sm:text-2xl font-bold">
                                <i class="fas fa-user-tie"></i>
                            </div>
                            <div class="text-xs text-blue-100">Empleado</div>
                        </div>
                    </div>
                </div>
                
                <!-- Decorative medical elements -->
                <div class="absolute top-4 right-4 opacity-20">
                    <i class="fas fa-plus text-white text-lg"></i>
                </div>
                <div class="absolute bottom-4 left-4 opacity-20">
                    <i class="fas fa-plus text-white text-lg"></i>
                </div>
            </div>

            <!-- Contenedor de mensajes din√°micos -->
            <div id="messagesContainer" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-md px-4 hidden"></div>

            <!-- Formulario -->
            <form method="post" enctype="multipart/form-data" class="space-y-6" id="empleadoForm">
                {% csrf_token %}

                <!-- Contenedor principal del formulario -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden">
                    <!-- Vista previa del empleado -->
                    <div class="bg-gray-50 dark:bg-gray-700 px-4 sm:px-6 py-6 border-b border-gray-200 dark:border-gray-600">
                        <div class="text-center">
                            <div class="relative mx-auto mb-4">
                                <!-- Contenedor de la foto clickeable -->
                                <div class="relative w-20 sm:w-24 h-20 sm:h-24 mx-auto rounded-full overflow-hidden shadow-lg border-4 border-white dark:border-gray-800 bg-white dark:bg-gray-800 transition-all duration-200 hover:shadow-xl cursor-pointer"
                                     onclick="openPhotoModal()"
                                     id="photoPreview">
                                    {% if object and object.foto %}
                                        <img src="{{ object.foto.url }}"
                                             alt="{{ object.nombre_completo }}"
                                             class="w-full h-full object-cover"
                                             id="previewImage" />
                                        <!-- Overlay para indicar que es clickeable -->
                                        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
                                            <i class="fas fa-search-plus text-white opacity-0 hover:opacity-100 transition-opacity duration-200 text-lg"></i>
                                        </div>
                                    {% else %}
                                        <div class="w-full h-full flex items-center justify-center">
                                            <i class="fas fa-user-tie text-3xl sm:text-4xl text-blue-600 dark:text-blue-400"></i>
                                        </div>
                                        <!-- Indicador de sin foto -->
                                        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-10 transition-all duration-200 flex items-center justify-center">
                                            <i class="fas fa-camera text-white opacity-0 hover:opacity-60 transition-opacity duration-200 text-sm"></i>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Nombre visible debajo de la foto -->
                                <div class="mt-3">
                                    <div class="text-sm font-bold text-blue-600 dark:text-blue-400" id="nombrePreviewStatic">
                                        {% if object %}
                                            {{ object.nombre_completo|truncatechars:20 }}
                                        {% else %}
                                            Nuevo Empleado
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <h3 class="text-sm font-medium text-gray-900 dark:text-white">
                                Vista previa del empleado
                            </h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                El nombre se actualizar√° mientras escribes ‚Ä¢ Haz clic en la foto para ampliar
                            </p>
                        </div>
                    </div>

                    <!-- Campos del formulario -->
                    <div class="p-4 sm:p-6 space-y-8">
                        <!-- SECCI√ìN 1: INFORMACI√ìN PERSONAL (Siempre visible) -->
                        <div class="bg-gray-50 dark:bg-gray-900/20 rounded-lg p-6 border border-gray-200 dark:border-gray-800">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 flex items-center">
                                <i class="fas fa-user mr-2 text-blue-500"></i>
                                Informaci√≥n Personal
                                <span class="text-gray-500 ml-2 text-sm">(Obligatorio)</span>
                            </h3>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                                <!-- Campo Nombres -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-user text-blue-500 mr-1"></i>
                                        {{ form.nombres.label }}
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">{{ form.nombres }}</div>
                                    {% if form.nombres.errors %}
                                        <div class="mt-1 text-red-600 text-sm">
                                            {% for error in form.nombres.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Campo Apellidos -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-user text-blue-500 mr-1"></i>
                                        {{ form.apellidos.label }}
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">{{ form.apellidos }}</div>
                                    {% if form.apellidos.errors %}
                                        <div class="mt-1 text-red-600 text-sm">
                                            {% for error in form.apellidos.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Campo C√©dula -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-id-card text-blue-500 mr-1"></i>
                                        {{ form.cedula_ecuatoriana.label }}
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">{{ form.cedula_ecuatoriana }}</div>
                                    {% if form.cedula_ecuatoriana.errors %}
                                        <div class="mt-1 text-red-600 text-sm">
                                            {% for error in form.cedula_ecuatoriana.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        10 d√≠gitos sin espacios ni guiones
                                    </p>
                                </div>

                                <!-- Campo DNI -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-passport text-blue-500 mr-1"></i>
                                        {{ form.dni.label }}
                                    </label>
                                    <div class="relative">{{ form.dni }}</div>
                                    {% if form.dni.errors %}
                                        <div class="mt-1 text-red-600 text-sm">
                                            {% for error in form.dni.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Documento internacional (opcional)
                                    </p>
                                </div>

                                <!-- Campo Fecha de Nacimiento -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-birthday-cake text-blue-500 mr-1"></i>
                                        {{ form.fecha_nacimiento.label }}
                                        <span class="text-red-500 ml-1">*</span>
                                    </label>
                                    <div class="relative">{{ form.fecha_nacimiento }}</div>
                                    {% if form.fecha_nacimiento.errors %}
                                        <div class="mt-1 text-red-600 text-sm">
                                            {% for error in form.fecha_nacimiento.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        No se permiten fechas futuras. Edad m√≠nima: 18 a√±os
                                    </p>
                                </div>

                                <!-- Campo Foto -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        <i class="fas fa-camera text-blue-500 mr-1"></i>
                                        {{ form.foto.label }}
                                    </label>
                                    <div class="relative">{{ form.foto }}</div>
                                    {% if form.foto.errors %}
                                        <div class="mt-1 text-red-600 text-sm">
                                            {% for error in form.foto.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Imagen del empleado (opcional)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- SECCI√ìN 2: INFORMACI√ìN LABORAL (Desplegable) -->
                        <div class="bg-gray-50 dark:bg-gray-900/20 rounded-lg border border-gray-200 dark:border-gray-800">
                            <button type="button"
                                    class="w-full p-6 text-left flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-900/30 transition-colors rounded-lg"
                                    onclick="toggleSection('laboral')">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white flex items-center">
                                    <i class="fas fa-briefcase mr-2 text-green-500"></i>
                                    Informaci√≥n Laboral
                                    <span class="text-gray-600 ml-2 text-sm">(Obligatorio)</span>
                                </h3>
                                <i class="fas fa-chevron-down text-gray-500 transform transition-transform duration-200" id="chevron-laboral"></i>
                            </button>
                            <div id="section-laboral" class="px-6 pb-6 hidden">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                                    <!-- Campo Cargo -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            <i class="fas fa-briefcase text-green-500 mr-1"></i>
                                            {{ form.cargo.label }}
                                            <span class="text-red-500 ml-1">*</span>
                                        </label>
                                        <div class="relative">{{ form.cargo }}</div>
                                        {% if form.cargo.errors %}
                                            <div class="mt-1 text-red-600 text-sm">
                                                {% for error in form.cargo.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Campo Sueldo -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            <i class="fas fa-dollar-sign text-green-500 mr-1"></i>
                                            {{ form.sueldo.label }}
                                            <span class="text-red-500 ml-1">*</span>
                                        </label>
                                        <div class="relative">{{ form.sueldo }}</div>
                                        {% if form.sueldo.errors %}
                                            <div class="mt-1 text-red-600 text-sm">
                                                {% for error in form.sueldo.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Salario mensual en d√≥lares
                                        </p>
                                    </div>

                                    <!-- Campo Fecha de Ingreso -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            <i class="fas fa-calendar-plus text-green-500 mr-1"></i>
                                            {{ form.fecha_ingreso.label }}
                                            <span class="text-red-500 ml-1">*</span>
                                        </label>
                                        <div class="relative">{{ form.fecha_ingreso }}</div>
                                        {% if form.fecha_ingreso.errors %}
                                            <div class="mt-1 text-red-600 text-sm">
                                                {% for error in form.fecha_ingreso.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            {% if object %}
                                                Fecha de ingreso del empleado (se permite modificar)
                                            {% else %}
                                                No se permiten fechas pasadas. M√≠nimo desde hoy
                                            {% endif %}
                                        </p>
                                    </div>

                                    <!-- Campo Activo -->
                                    <div class="flex items-center">
                                        <div class="flex items-center">
                                            {{ form.activo }}
                                            <label for="id_activo" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">
                                                <i class="fas fa-toggle-on text-green-500 mr-1"></i>
                                                {{ form.activo.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECCI√ìN 3: INFORMACI√ìN DE UBICACI√ìN (Desplegable) -->
                        <div class="bg-gray-50 dark:bg-gray-900/20 rounded-lg border border-gray-200 dark:border-gray-800">
                            <button type="button"
                                    class="w-full p-6 text-left flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-900/30 transition-colors rounded-lg"
                                    onclick="toggleSection('ubicacion')">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white flex items-center">
                                    <i class="fas fa-map-marker-alt mr-2 text-purple-500"></i>
                                    Informaci√≥n de Ubicaci√≥n
                                    <span class="text-gray-600 ml-2 text-sm">(Obligatorio)</span>
                                </h3>
                                <i class="fas fa-chevron-down text-gray-500 transform transition-transform duration-200" id="chevron-ubicacion"></i>
                            </button>
                            <div id="section-ubicacion" class="px-6 pb-6 hidden">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                                    <!-- Campo Direcci√≥n -->
                                    <div class="lg:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            <i class="fas fa-map-marker-alt text-purple-500 mr-1"></i>
                                            {{ form.direccion.label }}
                                            <span class="text-red-500 ml-1">*</span>
                                        </label>
                                        <div class="relative">{{ form.direccion }}</div>
                                        {% if form.direccion.errors %}
                                            <div class="mt-1 text-red-600 text-sm">
                                                {% for error in form.direccion.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Campo Latitud -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            <i class="fas fa-globe text-purple-500 mr-1"></i>
                                            {{ form.latitud.label }}
                                        </label>
                                        <div class="relative">{{ form.latitud }}</div>
                                        {% if form.latitud.errors %}
                                            <div class="mt-1 text-red-600 text-sm">
                                                {% for error in form.latitud.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Coordenada GPS (opcional)
                                        </p>
                                    </div>

                                    <!-- Campo Longitud -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                            <i class="fas fa-globe text-purple-500 mr-1"></i>
                                            {{ form.longitud.label }}
                                        </label>
                                        <div class="relative">{{ form.longitud }}</div>
                                        {% if form.longitud.errors %}
                                            <div class="mt-1 text-red-600 text-sm">
                                                {% for error in form.longitud.errors %}
                                                    <p>{{ error }}</p>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Coordenada GPS (opcional)
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de acci√≥n con dise√±o m√©dico -->
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 sticky bottom-0 z-10 border-2 border-gray-200 dark:border-gray-700">
                    <div class="flex flex-col sm:flex-row justify-end items-stretch sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                        <a href="{{ back_url }}"
                           class="inline-flex items-center justify-center px-6 py-3 border-2 border-gray-300 dark:border-gray-600 text-sm font-medium rounded-xl text-gray-700 dark:text-gray-300 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 hover:from-gray-100 hover:to-gray-200 dark:hover:from-gray-700 dark:hover:to-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                            <div class="w-6 h-6 bg-white/80 dark:bg-gray-900/80 rounded-full flex items-center justify-center mr-2 shadow-md">
                                <i class="fas fa-times text-red-500"></i>
                            </div>
                            Cancelar
                        </a>
                        <button type="submit"
                                id="submitBtn"
                                class="inline-flex items-center justify-center px-6 py-3 border-2 border-blue-500 dark:border-blue-400 text-sm font-medium rounded-xl text-white bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 dark:from-blue-700 dark:to-cyan-700 dark:hover:from-blue-800 dark:hover:to-cyan-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                            <div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center mr-2 shadow-md">
                                <i class="fas fa-save text-white"></i>
                            </div>
                            {{ grabar }}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver la foto ampliada -->
    <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95" id="modalContent">
            <!-- Header del modal -->
            <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-600">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-image mr-2 text-blue-500"></i>
                    Foto del Empleado
                </h3>
                <button onclick="closePhotoModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Contenido del modal -->
            <div class="p-6 text-center">
                <div class="mb-4">
                    <div class="w-48 h-48 mx-auto rounded-lg overflow-hidden shadow-lg bg-gray-100 dark:bg-gray-700">
                        <img id="modalImage" src="" alt="" class="w-full h-full object-cover" style="display: none" />
                        <div id="modalPlaceholder" class="w-full h-full flex items-center justify-center">
                            <div class="text-center">
                                <i class="fas fa-user-tie text-6xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Sin foto</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <h4 class="text-lg font-bold text-gray-900 dark:text-white mb-1" id="modalEmployeeName">
                        {% if object %}
                            {{ object.nombre_completo }}
                        {% else %}
                            Nuevo Empleado
                        {% endif %}
                    </h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400" id="modalEmployeeInfo">
                        {% if object and object.cargo %}
                            {{ object.cargo }}
                        {% else %}
                            Vista previa
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Footer del modal -->
            <div class="px-6 pb-4">
                <button onclick="closePhotoModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-check mr-2"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{% static 'js/messages.js' %}"></script>

    <style>
        /* Estilos adicionales para mejorar la responsividad */
        @media (max-height: 600px) {
            .container {
                padding-top: 1rem;
                padding-bottom: 1rem;
            }

            .bg-gradient-to-r {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .space-y-6 > * + * {
                margin-top: 1rem;
            }
        }

        /* Asegurar que los inputs se adapten correctamente */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            min-width: 0;
        }

        /* Mejorar el scroll en dispositivos m√≥viles */
        .overflow-y-auto {
            -webkit-overflow-scrolling: touch;
        }

        /* Hacer que las secciones desplegables sean m√°s compactas en m√≥viles */
        @media (max-width: 640px) {
            .space-y-8 > * + * {
                margin-top: 1.5rem;
            }
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Debug: Verificar el valor del campo fecha al cargar la p√°gina
            const fechaInput = document.getElementById("id_fecha_nacimiento");
            if (fechaInput) {
                console.log("Campo fecha encontrado:", fechaInput);
                console.log("Valor inicial del campo fecha:", fechaInput.value);
                console.log("Atributos del campo:", {
                    type: fechaInput.type,
                    max: fechaInput.getAttribute('max'),
                    name: fechaInput.name,
                    id: fechaInput.id
                });

                // Si el valor est√° vac√≠o pero hay un objeto empleado, intentar setearlo
                {% if object and object.fecha_nacimiento %}
                    if (!fechaInput.value) {
                        const fechaNacimiento = "{{ object.fecha_nacimiento|date:'Y-m-d' }}";
                        console.log("Intentando setear fecha desde el objeto:", fechaNacimiento);
                        fechaInput.value = fechaNacimiento;
                    }
                {% endif %}
            }

            // Funci√≥n para alternar secciones desplegables
            window.toggleSection = function (sectionName) {
                const section = document.getElementById(`section-${sectionName}`);
                const chevron = document.getElementById(`chevron-${sectionName}`);

                if (section.classList.contains("hidden")) {
                    section.classList.remove("hidden");
                    chevron.classList.add("rotate-180");
                } else {
                    section.classList.add("hidden");
                    chevron.classList.remove("rotate-180");
                }
            };

            // Abrir autom√°ticamente las secciones obligatorias
            toggleSection("laboral");
            toggleSection("ubicacion");

            // Actualizar vista previa del nombre
            const nombresInput = document.getElementById("id_nombres");
            const apellidosInput = document.getElementById("id_apellidos");
            const nombrePreviewStatic = document.getElementById("nombrePreviewStatic");

            function updateNombrePreview() {
                const nombres = nombresInput ? nombresInput.value.trim() : "";
                const apellidos = apellidosInput ? apellidosInput.value.trim() : "";

                if (nombres || apellidos) {
                    const nombreCompleto = `${apellidos} ${nombres}`.trim();
                    const nombreMedio = nombreCompleto.substring(0, 20) + (nombreCompleto.length > 20 ? "..." : "");

                    // Actualizar vista previa
                    if (nombrePreviewStatic) {
                        nombrePreviewStatic.textContent = nombreMedio;
                    }

                    // Actualizar modal si est√° abierto
                    const modalEmployeeName = document.getElementById("modalEmployeeName");
                    if (modalEmployeeName) {
                        modalEmployeeName.textContent = nombreCompleto || "Nuevo Empleado";
                    }
                } else {
                    if (nombrePreviewStatic) {
                        nombrePreviewStatic.textContent = "Nuevo Empleado";
                    }
                    const modalEmployeeName = document.getElementById("modalEmployeeName");
                    if (modalEmployeeName) {
                        modalEmployeeName.textContent = "Nuevo Empleado";
                    }
                }
            }

            if (nombresInput) {
                nombresInput.addEventListener("input", updateNombrePreview);
            }
            if (apellidosInput) {
                apellidosInput.addEventListener("input", updateNombrePreview);
            }

            // Vista previa de foto
            const fotoInput = document.getElementById("id_foto");
            if (fotoInput) {
                fotoInput.addEventListener("change", function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const previewImage = document.getElementById("previewImage");
                            const photoPreview = document.getElementById("photoPreview");

                            if (previewImage) {
                                previewImage.src = e.target.result;
                            } else {
                                // Crear nueva imagen si no existe
                                photoPreview.innerHTML = `
                                    <img src="${e.target.result}" alt="Foto del empleado" class="w-full h-full object-cover" id="previewImage" />
                                    <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 flex items-center justify-center">
                                        <i class="fas fa-search-plus text-white opacity-0 hover:opacity-100 transition-opacity duration-200 text-lg"></i>
                                    </div>
                                `;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // Validaci√≥n del formulario
            const form = document.getElementById("empleadoForm");
            if (form) {
                // Validaci√≥n de fecha de nacimiento
                const fechaNacimientoInput = document.getElementById("id_fecha_nacimiento");
                const fechaIngresoInput = document.getElementById("id_fecha_ingreso");

                if (fechaNacimientoInput) {
                    fechaNacimientoInput.addEventListener("change", function () {
                        const fechaNacimiento = new Date(this.value);
                        const hoy = new Date();
                        hoy.setHours(0, 0, 0, 0);

                        if (fechaNacimiento >= hoy) {
                            showMessage("‚ùå La fecha de nacimiento no puede ser hoy o una fecha futura.", "error");
                            this.value = "";
                            this.classList.add("border-red-500");
                            this.focus();
                            return;
                        }

                        // Verificar edad m√≠nima (18 a√±os)
                        const fechaMinima = new Date();
                        fechaMinima.setFullYear(fechaMinima.getFullYear() - 18);

                        if (fechaNacimiento > fechaMinima) {
                            showMessage("‚ö†Ô∏è El empleado debe tener al menos 18 a√±os de edad para trabajar.", "error");
                            this.value = "";
                            this.classList.add("border-red-500");
                            this.focus();
                            return;
                        }

                        // Verificar edad m√°xima (80 a√±os)
                        const fechaMaxima = new Date();
                        fechaMaxima.setFullYear(fechaMaxima.getFullYear() - 80);

                        if (fechaNacimiento < fechaMaxima) {
                            showMessage("‚ö†Ô∏è La fecha de nacimiento no puede ser anterior a 80 a√±os.", "warning");
                            this.value = "";
                            this.classList.add("border-red-500");
                            this.focus();
                            return;
                        }

                        // Si la fecha es v√°lida, remover el borde rojo
                        this.classList.remove("border-red-500");
                        showMessage("‚úÖ Fecha de nacimiento v√°lida.", "success");
                    });
                }

                if (fechaIngresoInput) {
                    fechaIngresoInput.addEventListener("change", function () {
                        const fechaIngreso = new Date(this.value);
                        const hoy = new Date();
                        hoy.setHours(0, 0, 0, 0);

                        // En modo edici√≥n, permitir fechas pasadas existentes
                        const isEditing = {{ object|yesno:"true,false" }};

                        if (!isEditing && fechaIngreso < hoy) {
                            showMessage("‚ùå La fecha de ingreso no puede ser anterior a hoy.", "error");
                            this.value = "";
                            this.classList.add("border-red-500");
                            this.focus();
                            return;
                        }

                        // Verificar que no sea muy lejana en el futuro (m√°ximo 1 a√±o)
                        const fechaMaxima = new Date();
                        fechaMaxima.setFullYear(fechaMaxima.getFullYear() + 1);

                        if (fechaIngreso > fechaMaxima) {
                            showMessage("‚ö†Ô∏è La fecha de ingreso no puede ser superior a un a√±o en el futuro.", "warning");
                            this.value = "";
                            this.classList.add("border-red-500");
                            this.focus();
                            return;
                        }

                        // Si la fecha es v√°lida, remover el borde rojo
                        this.classList.remove("border-red-500");
                        showMessage("‚úÖ Fecha de ingreso v√°lida.", "success");
                    });
                }

                // Validaci√≥n al enviar el formulario
                form.addEventListener("submit", function (e) {
                    const requiredFields = form.querySelectorAll("[required]");
                    let isValid = true;
                    let emptyFields = [];

                    requiredFields.forEach((field) => {
                        if (!field.value.trim()) {
                            isValid = false;
                            field.classList.add("border-red-500");

                            // Obtener el label del campo
                            const label = form.querySelector(`label[for="${field.id}"]`) || field.closest("div").querySelector("label");
                            if (label) {
                                emptyFields.push(label.textContent.replace("*", "").trim());
                            }
                        } else {
                            field.classList.remove("border-red-500");
                        }
                    });

                    if (!isValid) {
                        e.preventDefault();
                        const fieldsList = emptyFields.length > 3 ? emptyFields.slice(0, 3).join(", ") + "..." : emptyFields.join(", ");
                        showMessage(`‚ö†Ô∏è Campos obligatorios faltantes: ${fieldsList}`, "warning");

                        // Hacer scroll al primer campo vac√≠o
                        const firstEmptyField = form.querySelector("[required][value=''], [required]:not([value])");
                        if (firstEmptyField) {
                            // Abrir la secci√≥n que contiene el campo
                            const section = firstEmptyField.closest('[id^="section-"]');
                            if (section && section.classList.contains("hidden")) {
                                const sectionName = section.id.replace("section-", "");
                                toggleSection(sectionName);
                            }

                            firstEmptyField.scrollIntoView({
                                behavior: "smooth",
                                block: "center",
                            });
                            setTimeout(() => firstEmptyField.focus(), 500);
                        }
                        return false;
                    }

                    // Validaci√≥n adicional de fechas antes del env√≠o
                    if (fechaNacimientoInput && fechaNacimientoInput.value) {
                        const fechaNacimiento = new Date(fechaNacimientoInput.value);
                        const hoy = new Date();
                        hoy.setHours(0, 0, 0, 0);

                        if (fechaNacimiento >= hoy) {
                            e.preventDefault();
                            showMessage("‚ùå La fecha de nacimiento no puede ser hoy o una fecha futura.", "error");
                            fechaNacimientoInput.focus();
                            return false;
                        }
                    }

                    if (fechaIngresoInput && fechaIngresoInput.value) {
                        const fechaIngreso = new Date(fechaIngresoInput.value);
                        const hoy = new Date();
                        hoy.setHours(0, 0, 0, 0);

                        // En modo edici√≥n, permitir fechas pasadas existentes
                        const isEditing = {{ object|yesno:"true,false" }};

                        if (!isEditing && fechaIngreso < hoy) {
                            e.preventDefault();
                            showMessage("‚ùå La fecha de ingreso no puede ser anterior a hoy.", "error");
                            fechaIngresoInput.focus();
                            return false;
                        }
                    }

                    // Si todo est√° bien, mostrar mensaje de procesamiento
                    showMessage("üìã Guardando informaci√≥n del empleado...", "info");

                    // Deshabilitar el bot√≥n para evitar doble env√≠o
                    const submitBtn = document.getElementById("submitBtn");
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

                        // Re-habilitar despu√©s de 3 segundos por si hay errores
                        setTimeout(() => {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>{{ grabar }}';
                        }, 3000);
                    }
                });
            }

            // Auto-focus en el primer campo con error
            const firstError = document.querySelector(".text-red-600");
            if (firstError) {
                const errorField = firstError.closest("div").querySelector("input, select, textarea");
                if (errorField) {
                    errorField.focus();
                    errorField.scrollIntoView({
                        behavior: "smooth",
                        block: "center",
                    });

                    // Abrir la secci√≥n que contiene el campo con error
                    const section = errorField.closest('[id^="section-"]');
                    if (section && section.classList.contains("hidden")) {
                        const sectionName = section.id.replace("section-", "");
                        toggleSection(sectionName);
                    }
                }
            } else {
                // Si no hay errores, focus en el primer campo
                const firstField = document.querySelector("#id_nombres");
                if (firstField) {
                    firstField.focus();
                }
            }

            // Funci√≥n para ajustar la altura de la p√°gina din√°micamente
            function adjustViewport() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty("--vh", `${vh}px`);
            }

            // Ejecutar al cargar y al cambiar el tama√±o
            adjustViewport();
            window.addEventListener("resize", adjustViewport);
            window.addEventListener("orientationchange", adjustViewport);
        });

        // Funciones para el modal de foto
        function openPhotoModal() {
            const modal = document.getElementById("photoModal");
            const modalContent = document.getElementById("modalContent");
            const modalImage = document.getElementById("modalImage");
            const modalPlaceholder = document.getElementById("modalPlaceholder");
            const previewImage = document.getElementById("previewImage");

            if (modal && modalContent) {
                // Mostrar el modal
                modal.classList.remove("hidden");
                modal.classList.add("flex");

                // Animar la entrada
                setTimeout(() => {
                    modalContent.classList.remove("scale-95");
                    modalContent.classList.add("scale-100");
                }, 10);

                // Configurar la imagen del modal
                if (previewImage && previewImage.src) {
                    modalImage.src = previewImage.src;
                    modalImage.alt = previewImage.alt;
                    modalImage.style.display = "block";
                    modalPlaceholder.style.display = "none";
                } else {
                    modalImage.style.display = "none";
                    modalPlaceholder.style.display = "flex";
                }

                // Actualizar informaci√≥n del empleado en el modal
                const nombreCompleto = document.getElementById("nombrePreviewStatic").textContent;
                const modalEmployeeName = document.getElementById("modalEmployeeName");
                if (modalEmployeeName) {
                    modalEmployeeName.textContent = nombreCompleto;
                }

                // Prevenir scroll del body
                document.body.style.overflow = "hidden";
            }
        }

        function closePhotoModal() {
            const modal = document.getElementById("photoModal");
            const modalContent = document.getElementById("modalContent");

            if (modal && modalContent) {
                // Animar la salida
                modalContent.classList.remove("scale-100");
                modalContent.classList.add("scale-95");

                setTimeout(() => {
                    modal.classList.remove("flex");
                    modal.classList.add("hidden");
                    // Restaurar scroll del body
                    document.body.style.overflow = "";
                }, 300);
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.addEventListener("DOMContentLoaded", function() {
            const modal = document.getElementById("photoModal");
            if (modal) {
                modal.addEventListener("click", function(e) {
                    if (e.target === modal) {
                        closePhotoModal();
                    }
                });
            }

            // Cerrar modal con tecla Escape
            document.addEventListener("keydown", function(e) {
                if (e.key === "Escape") {
                    closePhotoModal();
                }
            });
        });
    </script>
{% endblock %}
